

================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Manage\Index.cshtml ================

@page
@model IndexModel
@{
    ViewData["Title"] = "Profile";
    ViewData["ActivePage"] = ManageNavPages.Index;
}

<h3>@ViewData["Title"]</h3>
<partial name="_StatusMessage" for="StatusMessage" />

<div class="row">
    <div class="col-md-6">
        <form id="profile-form" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <div class="form-floating mb-3">
                <input asp-for="Input.UserName" class="form-control" placeholder="Please choose your username." />
                <label asp-for="Input.UserName" class="form-label"></label>
                <span asp-validation-for="Input.UserName" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.PhoneNumber" class="form-control" placeholder="Please enter your phone number." />
                <label asp-for="Input.PhoneNumber" class="form-label"></label>
                <span asp-validation-for="Input.PhoneNumber" class="text-danger"></span>
            </div>

            <button id="update-profile-button" type="submit" class="w-100 btn btn-lg btn-primary">
                Save
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Manage\Index.cshtml.cs ================

#nullable disable

using System.ComponentModel.DataAnnotations;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace MarketZone.Areas.Identity.Pages.Account.Manage
{
	public class IndexModel : PageModel
	{
		private readonly UserManager<User> _userManager;
		private readonly SignInManager<User> _signInManager;

		public IndexModel(
			UserManager<User> userManager,
			SignInManager<User> signInManager)
		{
			_userManager = userManager;
			_signInManager = signInManager;
		}

		[TempData]
		public string StatusMessage { get; set; }

		[BindProperty]
		public InputModel Input { get; set; }

		public class InputModel
		{
			[Required]
			[Display(Name = "Username")]
			[StringLength(30, MinimumLength = 3, ErrorMessage = "Username must be between {2} and {1} characters.")]
			[RegularExpression(@"^[a-zA-Z0-9._-]+$", ErrorMessage = "Username can contain letters, numbers, dot, underscore and dash only.")]
			public string UserName { get; set; }

			[Phone]
			[Display(Name = "Phone number")]
			public string PhoneNumber { get; set; }
		}

		private async Task LoadAsync(User user)
		{
			var userName = await _userManager.GetUserNameAsync(user);
			var phoneNumber = await _userManager.GetPhoneNumberAsync(user);

			Input = new InputModel
			{
				UserName = userName,
				PhoneNumber = phoneNumber
			};
		}

		public async Task<IActionResult> OnGetAsync()
		{
			var user = await _userManager.GetUserAsync(User);
			if (user == null)
			{
				return NotFound($"Unable to load user with ID '{_userManager.GetUserId(User)}'.");
			}

			await LoadAsync(user);
			return Page();
		}

		public async Task<IActionResult> OnPostAsync()
		{
			var user = await _userManager.GetUserAsync(User);
			if (user == null)
			{
				return NotFound($"Unable to load user with ID '{_userManager.GetUserId(User)}'.");
			}

			if (!ModelState.IsValid)
			{
				await LoadAsync(user);
				return Page();
			}

			// Username
			var currentUserName = await _userManager.GetUserNameAsync(user);
			var newUserName = Input.UserName?.Trim();

			if (!string.Equals(currentUserName, newUserName, StringComparison.Ordinal))
			{
				var existing = await _userManager.FindByNameAsync(newUserName);
				if (existing != null && existing.Id != user.Id)
				{
					ModelState.AddModelError("Input.UserName", "This username is already taken.");
					await LoadAsync(user);
					return Page();
				}

				var setUserNameResult = await _userManager.SetUserNameAsync(user, newUserName);
				if (!setUserNameResult.Succeeded)
				{
					foreach (var error in setUserNameResult.Errors)
					{
						ModelState.AddModelError(string.Empty, error.Description);
					}

					await LoadAsync(user);
					return Page();
				}
			}

			// Phone
			var phoneNumber = await _userManager.GetPhoneNumberAsync(user);
			if (Input.PhoneNumber != phoneNumber)
			{
				var setPhoneResult = await _userManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
				if (!setPhoneResult.Succeeded)
				{
					StatusMessage = "Unexpected error when trying to set phone number.";
					return RedirectToPage();
				}
			}

			await _signInManager.RefreshSignInAsync(user);
			StatusMessage = "Your profile has been updated.";
			return RedirectToPage();
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Manage\ManageNavPages.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using System;
using Microsoft.AspNetCore.Mvc.Rendering;

namespace  MarketZone.Areas.Identity.Pages.Account.Manage
{
    /// <summary>
    ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
    ///     directly from your code. This API may change or be removed in future releases.
    /// </summary>
    public static class ManageNavPages
    {
        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string Index => "Index";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string Email => "Email";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string ChangePassword => "ChangePassword";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string DownloadPersonalData => "DownloadPersonalData";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string DeletePersonalData => "DeletePersonalData";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string ExternalLogins => "ExternalLogins";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string PersonalData => "PersonalData";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string TwoFactorAuthentication => "TwoFactorAuthentication";

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string IndexNavClass(ViewContext viewContext) => PageNavClass(viewContext, Index);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string EmailNavClass(ViewContext viewContext) => PageNavClass(viewContext, Email);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string ChangePasswordNavClass(ViewContext viewContext) => PageNavClass(viewContext, ChangePassword);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string DownloadPersonalDataNavClass(ViewContext viewContext) => PageNavClass(viewContext, DownloadPersonalData);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string DeletePersonalDataNavClass(ViewContext viewContext) => PageNavClass(viewContext, DeletePersonalData);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string ExternalLoginsNavClass(ViewContext viewContext) => PageNavClass(viewContext, ExternalLogins);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string PersonalDataNavClass(ViewContext viewContext) => PageNavClass(viewContext, PersonalData);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string TwoFactorAuthenticationNavClass(ViewContext viewContext) => PageNavClass(viewContext, TwoFactorAuthentication);

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public static string PageNavClass(ViewContext viewContext, string page)
        {
            var activePage = viewContext.ViewData["ActivePage"] as string
                ?? System.IO.Path.GetFileNameWithoutExtension(viewContext.ActionDescriptor.DisplayName);
            return string.Equals(activePage, page, StringComparison.OrdinalIgnoreCase) ? "active" : null;
        }
    }
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Manage\_ManageNav.cshtml ================

@inject SignInManager<User> SignInManager
@{
    var hasExternalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).Any();
}
<ul class="nav nav-pills flex-column">
    <li class="nav-item"><a class="nav-link @ManageNavPages.IndexNavClass(ViewContext)" id="profile" asp-page="./Index">Profile</a></li>
    <li class="nav-item"><a class="nav-link @ManageNavPages.EmailNavClass(ViewContext)" id="email" asp-page="./Email">Email</a></li>
    <li class="nav-item"><a class="nav-link @ManageNavPages.ChangePasswordNavClass(ViewContext)" id="change-password" asp-page="./ChangePassword">Password</a></li>
    @if (hasExternalLogins)
    {
        <li id="external-logins" class="nav-item"><a id="external-login" class="nav-link @ManageNavPages.ExternalLoginsNavClass(ViewContext)" asp-page="./ExternalLogins">External logins</a></li>
    }
    <li class="nav-item"><a class="nav-link @ManageNavPages.TwoFactorAuthenticationNavClass(ViewContext)" id="two-factor" asp-page="./TwoFactorAuthentication">Two-factor authentication</a></li>
    <li class="nav-item"><a class="nav-link @ManageNavPages.PersonalDataNavClass(ViewContext)" id="personal-data" asp-page="./PersonalData">Personal data</a></li>
</ul>


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Manage\_ViewImports.cshtml ================

@using MarketZone.Areas.Identity.Pages.Account.Manage


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ConfirmEmail.cshtml ================

@page
@model ConfirmEmailModel
@{
    ViewData["Title"] = "Confirm email";
}

<h1>@ViewData["Title"]</h1>
<partial name="_StatusMessage" model="Model.StatusMessage" />


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ConfirmEmail.cshtml.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using System;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.WebUtilities;

namespace MarketZone.Areas.Identity.Pages.Account
{
    public class ConfirmEmailModel : PageModel
    {
        private readonly UserManager<User> _userManager;

        public ConfirmEmailModel(UserManager<User> userManager)
        {
            _userManager = userManager;
        }

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        [TempData]
        public string StatusMessage { get; set; }
        public async Task<IActionResult> OnGetAsync(string userId, string code)
        {
            if (userId == null || code == null)
            {
                return RedirectToPage("/Index");
            }

            var user = await _userManager.FindByIdAsync(userId);
            if (user == null)
            {
                return NotFound($"Unable to load user with ID '{userId}'.");
            }

            code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(code));
            var result = await _userManager.ConfirmEmailAsync(user, code);
            StatusMessage = result.Succeeded ? "Thank you for confirming your email." : "Error confirming your email.";
            return Page();
        }
    }
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ExternalLogin.cshtml ================

@page
@model ExternalLoginModel
@{
    ViewData["Title"] = "Register";
}

<h1>@ViewData["Title"]</h1>
<h2 id="external-login-title">Associate your @Model.ProviderDisplayName account.</h2>
<hr />

<p id="external-login-description" class="text-info">
    You've successfully authenticated with <strong>@Model.ProviderDisplayName</strong>.
    Please enter an email address for this site below and click the Register button to finish
    logging in.
</p>

<div class="row">
    <div class="col-md-4">
        <form asp-page-handler="Confirmation" asp-route-returnUrl="@Model.ReturnUrl" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>
            <div class="form-floating mb-3">
                <input asp-for="Input.Email" class="form-control" autocomplete="email" placeholder="Please enter your email."/>
                <label asp-for="Input.Email" class="form-label"></label>
                <span asp-validation-for="Input.Email" class="text-danger"></span>
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Register</button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ExternalLogin.cshtml.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace MarketZone.Areas.Identity.Pages.Account
{
	[AllowAnonymous]
	public class ExternalLoginModel : PageModel
	{
		private readonly SignInManager<User> _signInManager;
		private readonly UserManager<User> _userManager;
		private readonly IUserStore<User> _userStore;
		private readonly IUserEmailStore<User> _emailStore;
		private readonly IEmailSender _emailSender;
		private readonly ILogger<ExternalLoginModel> _logger;

		public ExternalLoginModel(
			SignInManager<User> signInManager,
			UserManager<User> userManager,
			IUserStore<User> userStore,
			ILogger<ExternalLoginModel> logger,
			IEmailSender emailSender)
		{
			_signInManager = signInManager;
			_userManager = userManager;
			_userStore = userStore;
			_emailStore = GetEmailStore();
			_logger = logger;
			_emailSender = emailSender;
		}

		[BindProperty]
		public InputModel Input { get; set; }

		public string ProviderDisplayName { get; set; }
		public string ReturnUrl { get; set; }

		[TempData]
		public string ErrorMessage { get; set; }

		public class InputModel
		{
			[Required]
			[EmailAddress]
			public string Email { get; set; }
		}

		public IActionResult OnGet() => RedirectToPage("./Login");

		public IActionResult OnPost(string provider, string returnUrl = null)
		{
			returnUrl ??= Url.Content("~/");

			var redirectUrl = Url.Page("./ExternalLogin", pageHandler: "Callback", values: new { returnUrl });
			var properties = _signInManager.ConfigureExternalAuthenticationProperties(provider, redirectUrl);
			return new ChallengeResult(provider, properties);
		}

		public async Task<IActionResult> OnGetCallbackAsync(string returnUrl = null, string remoteError = null)
		{
			returnUrl ??= Url.Content("~/");

			if (remoteError != null)
			{
				ErrorMessage = $"Error from external provider: {remoteError}";
				return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
			}

			var info = await _signInManager.GetExternalLoginInfoAsync();
			if (info == null)
			{
				ErrorMessage = "Error loading external login information.";
				return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
			}

			var result = await _signInManager.ExternalLoginSignInAsync(
				info.LoginProvider,
				info.ProviderKey,
				isPersistent: false,
				bypassTwoFactor: true);

			if (result.Succeeded)
			{
				_logger.LogInformation("{Name} logged in with {LoginProvider} provider.",
					info.Principal.Identity?.Name, info.LoginProvider);

				return LocalRedirect(returnUrl);
			}

			if (result.IsLockedOut)
				return RedirectToPage("./Lockout");

			var email = info.Principal.FindFirstValue(ClaimTypes.Email);

			if (!string.IsNullOrWhiteSpace(email))
			{
				var existingUser = await _userManager.FindByEmailAsync(email);

				if (existingUser != null)
				{
					if (!existingUser.EmailConfirmed)
					{
						ErrorMessage =
							"An account with this email already exists but it is not confirmed. " +
							"Please confirm your email or use 'Resend email confirmation'.";

						return RedirectToPage("./Login", new { ReturnUrl = returnUrl, email, showResend = true });
					}

					var logins = await _userManager.GetLoginsAsync(existingUser);
					bool alreadyLinked = logins.Any(l =>
						l.LoginProvider.Equals(info.LoginProvider, StringComparison.OrdinalIgnoreCase) &&
						l.ProviderKey == info.ProviderKey);

					if (!alreadyLinked)
					{
						var addLoginResult = await _userManager.AddLoginAsync(existingUser, info);
						if (!addLoginResult.Succeeded)
						{
							ErrorMessage = "This Google account is already linked to another user. Please log in using the correct account.";
							return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
						}
					}

					await _signInManager.SignInAsync(existingUser, isPersistent: false);

					_logger.LogInformation("Linked {LoginProvider} to existing user {UserId} and signed in.",
						info.LoginProvider, existingUser.Id);

					return LocalRedirect(returnUrl);
				}
			}

			ReturnUrl = returnUrl;
			ProviderDisplayName = info.ProviderDisplayName;

			if (!string.IsNullOrWhiteSpace(email))
			{
				Input = new InputModel { Email = email };
			}

			return Page();
		}

		public async Task<IActionResult> OnPostConfirmationAsync(string returnUrl = null)
		{
			returnUrl ??= Url.Content("~/");

			var info = await _signInManager.GetExternalLoginInfoAsync();
			if (info == null)
			{
				ErrorMessage = "Error loading external login information during confirmation.";
				return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
			}

			if (ModelState.IsValid)
			{
				var existing = await _userManager.FindByEmailAsync(Input.Email);
				if (existing != null)
				{
					ErrorMessage = "An account with this email already exists. Please log in.";
					return RedirectToPage("./Login", new { ReturnUrl = returnUrl });
				}

				var user = CreateUser();
				user.CreatedOn = DateTime.UtcNow;

				// Google already verifies email ownership -> treat as confirmed
				user.EmailConfirmed = true;

				await _userStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
				await _emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);

				var createResult = await _userManager.CreateAsync(user);
				if (createResult.Succeeded)
				{
					var loginResult = await _userManager.AddLoginAsync(user, info);
					if (loginResult.Succeeded)
					{
						_logger.LogInformation("User created an account using {Name} provider.", info.LoginProvider);

						await _signInManager.SignInAsync(user, isPersistent: false, info.LoginProvider);
						return LocalRedirect(returnUrl);
					}

					foreach (var error in loginResult.Errors)
						ModelState.AddModelError(string.Empty, error.Description);
				}
				else
				{
					foreach (var error in createResult.Errors)
						ModelState.AddModelError(string.Empty, error.Description);
				}
			}

			ProviderDisplayName = info.ProviderDisplayName;
			ReturnUrl = returnUrl;
			return Page();
		}

		private User CreateUser()
		{
			try
			{
				return Activator.CreateInstance<User>();
			}
			catch
			{
				throw new InvalidOperationException($"Can't create an instance of '{nameof(User)}'. " +
					$"Ensure that '{nameof(User)}' is not an abstract class and has a parameterless constructor, or alternatively " +
					$"override the external login page in /Areas/Identity/Pages/Account/ExternalLogin.cshtml");
			}
		}

		private IUserEmailStore<User> GetEmailStore()
		{
			if (!_userManager.SupportsUserEmail)
				throw new NotSupportedException("The default UI requires a user store with email support.");

			return (IUserEmailStore<User>)_userStore;
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Login.cshtml ================

@page
@model LoginModel

@{
    ViewData["Title"] = "Log in";
}

<h1>@ViewData["Title"]</h1>

<div class="row">
    <div class="col-md-4">
        <section>
            <form id="account" method="post">
                <h2>Use a local account to log in.</h2>
                <hr />

                @* Status message from resend/forgot actions *@
                @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
                {
                    <div class="alert alert-info" role="alert">
                        @Model.StatusMessage
                    </div>
                }

                <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

                <div class="form-floating mb-3">
                    <input asp-for="Input.Email"
                           class="form-control"
                           autocomplete="username"
                           aria-required="true"
                           placeholder="name@example.com" />
                    <label asp-for="Input.Email" class="form-label">Email</label>
                    <span asp-validation-for="Input.Email" class="text-danger"></span>
                </div>

                <div class="form-floating mb-3">
                    <input asp-for="Input.Password"
                           class="form-control"
                           autocomplete="current-password"
                           aria-required="true"
                           placeholder="password" />
                    <label asp-for="Input.Password" class="form-label">Password</label>
                    <span asp-validation-for="Input.Password" class="text-danger"></span>
                </div>

                <div class="checkbox mb-3">
                    <label asp-for="Input.RememberMe" class="form-label">
                        <input class="form-check-input" asp-for="Input.RememberMe" />
                        @Html.DisplayNameFor(m => m.Input.RememberMe)
                    </label>
                </div>

                <div>
                    <button id="login-submit" type="submit" class="w-100 btn btn-lg btn-primary">
                        Log in
                    </button>
                </div>

                <div class="mt-3 d-flex flex-column gap-2">

                    <button type="submit"
                            class="btn btn-outline-secondary"
                            asp-page-handler="ForgotPassword"
                            formnovalidate
                            data-cooldown-key="login_forgot"
                            data-cooldown-seconds="30">
                        Forgot your password?
                    </button>

                    <button type="submit"
                            class="btn btn-outline-secondary"
                            asp-page-handler="ResendConfirmation"
                            formnovalidate
                            data-cooldown-key="login_resend"
                            data-cooldown-seconds="30">
                        Resend email confirmation
                    </button>

                    <a asp-page="./Register"
                       asp-route-returnUrl="@Model.ReturnUrl">
                        Register as a new user
                    </a>

                </div>
            </form>
        </section>
    </div>

    <div class="col-md-6 col-md-offset-2">
        <section>
            <h3>Use another service to log in.</h3>
            <hr />

            @if ((Model.ExternalLogins?.Count ?? 0) == 0)
            {
                <div class="alert alert-warning">
                    External login providers are currently unavailable.
                </div>
            }
            else
            {
                <form id="external-account"
                      asp-page="./ExternalLogin"
                      method="post"
                      class="form-horizontal">

                    <input type="hidden" name="flow" value="login" />
                    <input type="hidden" name="returnUrl"
                           value="@(Model.ReturnUrl ?? Url.Content("~/"))" />

                    <div>
                        <p>
                            @foreach (var provider in Model.ExternalLogins!)
                            {
                                <button type="submit"
                                        class="btn btn-primary"
                                        name="provider"
                                        value="@provider.Name"
                                        title="Log in using your @provider.DisplayName account">
                                    @provider.DisplayName
                                </button>
                            }
                        </p>
                    </div>
                </form>
            }
        </section>
    </div>
</div>

@* Server-controlled cooldown start marker *@
<span id="authCooldownStart"
      data-key="@TempData["StartCooldownKey"]"
      data-seconds="@TempData["StartCooldownSeconds"]"
      hidden></span>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/login-persist.js" asp-append-version="true"></script>
    <script src="~/js/auth-cooldown.js" asp-append-version="true"></script>
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Login.cshtml.cs ================

#nullable disable

using MarketZone.Data.Models;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.WebUtilities;
using System.ComponentModel.DataAnnotations;
using System.Text;
using System.Text.Encodings.Web;

namespace MarketZone.Areas.Identity.Pages.Account
{
	public class LoginModel : PageModel
	{
		private readonly SignInManager<User> _signInManager;
		private readonly UserManager<User> _userManager;
		private readonly IEmailSender _emailSender;
		private readonly ILogger<LoginModel> _logger;

		public LoginModel(
			SignInManager<User> signInManager,
			UserManager<User> userManager,
			IEmailSender emailSender,
			ILogger<LoginModel> logger)
		{
			_signInManager = signInManager;
			_userManager = userManager;
			_emailSender = emailSender;
			_logger = logger;
		}

		[BindProperty]
		public InputModel Input { get; set; }

		public IList<AuthenticationScheme> ExternalLogins { get; set; }

		public string ReturnUrl { get; set; }

		[TempData]
		public string ErrorMessage { get; set; }

		[TempData]
		public string StatusMessage { get; set; }

		public class InputModel
		{
			[Required]
			[EmailAddress]
			public string Email { get; set; }

			[Required]
			[DataType(DataType.Password)]
			public string Password { get; set; }

			[Display(Name = "Remember me?")]
			public bool RememberMe { get; set; }
		}

		public async Task OnGetAsync(string returnUrl = null, string email = null)
		{
			if (!string.IsNullOrEmpty(ErrorMessage))
				ModelState.AddModelError(string.Empty, ErrorMessage);

			returnUrl ??= Url.Content("~/");

			await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);

			ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();
			ReturnUrl = returnUrl;

			if (!string.IsNullOrWhiteSpace(email))
			{
				Input ??= new InputModel();
				Input.Email = email;
			}
		}

		public async Task<IActionResult> OnPostAsync(string returnUrl = null)
		{
			returnUrl ??= Url.Content("~/");
			ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();

			if (!ModelState.IsValid)
				return Page();

			var user = await _userManager.FindByEmailAsync(Input.Email);

			if (user == null)
			{
				ModelState.AddModelError(string.Empty, "Invalid login attempt.");
				return Page();
			}

			if (!user.EmailConfirmed)
			{
				ModelState.AddModelError(string.Empty, "You must verify your email before logging in.");
				return Page();
			}

			var result = await _signInManager.PasswordSignInAsync(
				user.UserName,
				Input.Password,
				Input.RememberMe,
				lockoutOnFailure: false);

			if (result.Succeeded)
			{
				_logger.LogInformation("User logged in.");
				return LocalRedirect(returnUrl);
			}

			if (result.RequiresTwoFactor)
			{
				return RedirectToPage("./LoginWith2fa", new
				{
					ReturnUrl = returnUrl,
					RememberMe = Input.RememberMe
				});
			}

			if (result.IsLockedOut)
				return RedirectToPage("./Lockout");

			ModelState.AddModelError(string.Empty, "Invalid login attempt.");
			return Page();
		}

		public async Task<IActionResult> OnPostResendConfirmationAsync(string returnUrl = null)
		{
			returnUrl ??= Url.Content("~/");

			var email = Input?.Email?.Trim();
			if (string.IsNullOrWhiteSpace(email))
			{
				TempData["StatusMessage"] = "Please enter your email first.";
				return RedirectToPage("./Login", new { returnUrl });
			}

			var user = await _userManager.FindByEmailAsync(email);

			if (user == null)
			{
				TempData["StatusMessage"] = "No account found with this email. No email was sent.";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			var logins = await _userManager.GetLoginsAsync(user);
			if (logins.Any())
			{
				TempData["StatusMessage"] = "This account uses Google sign-in. Email confirmation resend is not available.";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			if (user.EmailConfirmed)
			{
				TempData["StatusMessage"] = "This email is already confirmed. Please log in.";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			var userId = await _userManager.GetUserIdAsync(user);
			var code = await _userManager.GenerateEmailConfirmationTokenAsync(user);
			code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

			var callbackUrl = Url.Page(
				"/Account/ConfirmEmail",
				pageHandler: null,
				values: new { area = "Identity", userId, code },
				protocol: Request.Scheme);

			await _emailSender.SendEmailAsync(
				email,
				"Confirm your email",
				$"Please confirm your account by <a href='{HtmlEncoder.Default.Encode(callbackUrl)}'>clicking here</a>.");

			TempData["StatusMessage"] = "Verification email sent. Please check your email.";

			TempData["StartCooldownKey"] = "login_resend";
			TempData["StartCooldownSeconds"] = 30;

			return RedirectToPage("./Login", new { returnUrl, email });
		}

		public async Task<IActionResult> OnPostForgotPasswordAsync(string returnUrl = null)
		{
			returnUrl ??= Url.Content("~/");

			var email = Input?.Email?.Trim();
			if (string.IsNullOrWhiteSpace(email))
			{
				TempData["StatusMessage"] = "Please enter your email first.";
				return RedirectToPage("./Login", new { returnUrl });
			}

			var user = await _userManager.FindByEmailAsync(email);

			if (user == null)
			{
				TempData["StatusMessage"] = "No account found with this email. No email was sent.";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			var logins = await _userManager.GetLoginsAsync(user);
			if (logins.Any())
			{
				TempData["StatusMessage"] = "This account uses Google sign-in. Password reset is not available.";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			if (!user.EmailConfirmed)
			{
				TempData["StatusMessage"] = "Your email is not confirmed. Please confirm it first (or resend confirmation).";
				return RedirectToPage("./Login", new { returnUrl, email });
			}

			var code = await _userManager.GeneratePasswordResetTokenAsync(user);
			code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

			var callbackUrl = Url.Page(
				"/Account/ResetPassword",
				pageHandler: null,
				values: new { area = "Identity", code, email },
				protocol: Request.Scheme);

			await _emailSender.SendEmailAsync(
				email,
				"Reset Password",
				$"Please reset your password by <a href='{HtmlEncoder.Default.Encode(callbackUrl)}'>clicking here</a>.");

			TempData["StatusMessage"] = "Password reset email sent. Please check your email.";

			TempData["StartCooldownKey"] = "login_forgot";
			TempData["StartCooldownSeconds"] = 30;

			return RedirectToPage("./Login", new { returnUrl, email });
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Register.cshtml ================

@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<h1>@ViewData["Title"]</h1>

<div class="row">
    <div class="col-md-4">
        <form id="registerForm" method="post">
            <h2>Create a new account.</h2>
            <hr />

            @if (!string.IsNullOrWhiteSpace(Model.InfoMessage))
            {
                <div class="alert alert-info" role="alert">
                    @Model.InfoMessage
                </div>
            }

            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                <label asp-for="Input.Email">Email</label>
                <span asp-validation-for="Input.Email" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label asp-for="Input.Password">Password</label>
                <span asp-validation-for="Input.Password" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label asp-for="Input.ConfirmPassword">Confirm Password</label>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>

            <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">
                Register
            </button>

            <button type="submit"
                    class="w-100 btn btn-outline-secondary mt-2"
                    asp-page-handler="ResendConfirmation"
                    formnovalidate
                    data-cooldown-key="register_resend"
                    data-cooldown-seconds="30">
                Resend email confirmation
            </button>
        </form>
    </div>

    <div class="col-md-6 col-md-offset-2">
        <section>
            <h3>Use another service to register.</h3>
            <hr />

            @if ((Model.ExternalLogins?.Count ?? 0) == 0)
            {
                <div class="alert alert-warning">
                    External register providers are currently unavailable.
                </div>
            }
            else
            {
                <form id="external-account"
                      asp-page="./ExternalLogin"
                      method="post"
                      class="form-horizontal">

                    <input type="hidden" name="flow" value="register" />
                    <input type="hidden" name="returnUrl" value="~/" />

                    <p>
                        @foreach (var provider in Model.ExternalLogins!)
                        {
                            <button type="submit"
                                    class="btn btn-primary"
                                    name="provider"
                                    value="@provider.Name"
                                    title="Register using your @provider.DisplayName account">
                                @provider.DisplayName
                            </button>
                        }
                    </p>
                </form>
            }
        </section>
    </div>
</div>

@* Server-controlled cooldown start marker *@
<span id="authCooldownStart"
      data-key="@TempData["StartCooldownKey"]"
      data-seconds="@TempData["StartCooldownSeconds"]"
      hidden></span>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/auth-cooldown.js" asp-append-version="true"></script>
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\Register.cshtml.cs ================

#nullable disable

using MarketZone.Data.Models;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.WebUtilities;
using System.ComponentModel.DataAnnotations;
using System.Text;
using System.Text.Encodings.Web;

namespace MarketZone.Areas.Identity.Pages.Account
{
	public class RegisterModel : PageModel
	{
		private readonly SignInManager<User> _signInManager;
		private readonly UserManager<User> _userManager;
		private readonly IUserStore<User> _userStore;
		private readonly IUserEmailStore<User> _emailStore;
		private readonly ILogger<RegisterModel> _logger;
		private readonly IEmailSender _emailSender;

		public RegisterModel(
			UserManager<User> userManager,
			IUserStore<User> userStore,
			SignInManager<User> signInManager,
			ILogger<RegisterModel> logger,
			IEmailSender emailSender)
		{
			_userManager = userManager;
			_userStore = userStore;
			_emailStore = GetEmailStore();
			_signInManager = signInManager;
			_logger = logger;
			_emailSender = emailSender;
		}

		[BindProperty]
		public InputModel Input { get; set; }

		public IList<AuthenticationScheme> ExternalLogins { get; set; }

		[TempData]
		public string InfoMessage { get; set; }

		public class InputModel
		{
			[Required]
			[EmailAddress]
			[Display(Name = "Email")]
			public string Email { get; set; }

			[Required]
			[StringLength(100, MinimumLength = 6)]
			[DataType(DataType.Password)]
			[Display(Name = "Password")]
			public string Password { get; set; }

			[DataType(DataType.Password)]
			[Display(Name = "Confirm password")]
			[Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
			public string ConfirmPassword { get; set; }
		}

		public async Task OnGetAsync(string email = null)
		{
			ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();

			if (!string.IsNullOrWhiteSpace(email))
			{
				Input ??= new InputModel();
				Input.Email = email;
			}
		}

		public async Task<IActionResult> OnPostAsync()
		{
			ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();

			if (!ModelState.IsValid)
				return Page();

			var existingUser = await _userManager.FindByEmailAsync(Input.Email);
			if (existingUser != null)
			{
				ModelState.AddModelError("Input.Email", "An account with this email already exists.");
				return Page();
			}

			var user = CreateUser();
			user.CreatedOn = DateTime.UtcNow;

			await _userStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
			await _emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);

			var result = await _userManager.CreateAsync(user, Input.Password);

			if (!result.Succeeded)
			{
				foreach (var error in result.Errors)
				{
					if (error.Code == "DuplicateEmail" || error.Code == "DuplicateUserName")
						ModelState.AddModelError("Input.Email", "An account with this email already exists.");
					else
						ModelState.AddModelError(string.Empty, error.Description);
				}

				return Page();
			}

			_logger.LogInformation("User created a new account with password.");

			await SendConfirmationEmailAsync(user, Input.Email);
			InfoMessage = "Confirmation email sent. Please check your email.";

			return RedirectToPage("./Register", new { email = Input.Email });
		}

		public async Task<IActionResult> OnPostResendConfirmationAsync()
		{
			ExternalLogins = (await _signInManager.GetExternalAuthenticationSchemesAsync()).ToList();

			ModelState.Remove("Input.Password");
			ModelState.Remove("Input.ConfirmPassword");

			if (!ModelState.IsValid)
				return Page();

			var email = Input?.Email?.Trim();
			if (string.IsNullOrWhiteSpace(email))
			{
				ModelState.AddModelError("Input.Email", "Please enter your email first.");
				return Page();
			}

			var user = await _userManager.FindByEmailAsync(email);

			if (user == null)
			{
				InfoMessage = "No account found with this email. No email was sent.";
				return RedirectToPage("./Register", new { email });
			}

			var logins = await _userManager.GetLoginsAsync(user);
			if (logins.Any())
			{
				InfoMessage = "This account uses Google sign-in. Email confirmation resend is not available.";
				return RedirectToPage("./Register", new { email });
			}

			if (user.EmailConfirmed)
			{
				InfoMessage = "This email is already confirmed. Please log in.";
				return RedirectToPage("./Register", new { email });
			}

			await SendConfirmationEmailAsync(user, email);

			InfoMessage = "Confirmation email resent. Please check your email.";

			TempData["StartCooldownKey"] = "register_resend";
			TempData["StartCooldownSeconds"] = 30;

			return RedirectToPage("./Register", new { email });
		}

		private async Task SendConfirmationEmailAsync(User user, string email)
		{
			var userId = await _userManager.GetUserIdAsync(user);

			var code = await _userManager.GenerateEmailConfirmationTokenAsync(user);
			code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

			var callbackUrl = Url.Page(
				"/Account/ConfirmEmail",
				pageHandler: null,
				values: new { area = "Identity", userId, code },
				protocol: Request.Scheme);

			await _emailSender.SendEmailAsync(
				email,
				"Confirm your email",
				$"Please confirm your account by <a href='{HtmlEncoder.Default.Encode(callbackUrl)}'>clicking here</a>.");
		}

		private User CreateUser()
		{
			try
			{
				return Activator.CreateInstance<User>();
			}
			catch
			{
				throw new InvalidOperationException(
					$"Can't create an instance of '{nameof(User)}'. " +
					$"Ensure that '{nameof(User)}' is not abstract and has a parameterless constructor."
				);
			}
		}

		private IUserEmailStore<User> GetEmailStore()
		{
			if (!_userManager.SupportsUserEmail)
				throw new NotSupportedException("The default UI requires a user store with email support.");

			return (IUserEmailStore<User>)_userStore;
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\RegisterConfirmation.cshtml ================

@page
@model RegisterConfirmationModel
@{
    ViewData["Title"] = "Register confirmation";
}

<h1>@ViewData["Title"]</h1>
@{
    if (@Model.DisplayConfirmAccountLink)
    {
<p>
    This app does not currently have a real email sender registered, see <a href="https://aka.ms/aspaccountconf">these docs</a> for how to configure a real email sender.
    Normally this would be emailed: <a id="confirm-link" href="@Model.EmailConfirmationUrl">Click here to confirm your account</a>
</p>
    }
    else
    {
<p>
        Please check your email to confirm your account.
</p>
    }
}



================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\RegisterConfirmation.cshtml.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using System;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.WebUtilities;

namespace MarketZone.Areas.Identity.Pages.Account
{
    [AllowAnonymous]
    public class RegisterConfirmationModel : PageModel
    {
        private readonly UserManager<User> _userManager;
        private readonly IEmailSender _sender;

        public RegisterConfirmationModel(UserManager<User> userManager, IEmailSender sender)
        {
            _userManager = userManager;
            _sender = sender;
        }

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public string Email { get; set; }

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public bool DisplayConfirmAccountLink { get; set; }

        /// <summary>
        ///     This API supports the ASP.NET Core Identity default UI infrastructure and is not intended to be used
        ///     directly from your code. This API may change or be removed in future releases.
        /// </summary>
        public string EmailConfirmationUrl { get; set; }

        public async Task<IActionResult> OnGetAsync(string email, string returnUrl = null)
        {
            if (email == null)
            {
                return RedirectToPage("/Index");
            }
            returnUrl = returnUrl ?? Url.Content("~/");

            var user = await _userManager.FindByEmailAsync(email);
            if (user == null)
            {
                return NotFound($"Unable to load user with email '{email}'.");
            }

            Email = email;
            // Once you add a real email sender, you should remove this code that lets you confirm the account
            DisplayConfirmAccountLink = true;
            if (DisplayConfirmAccountLink)
            {
                var userId = await _userManager.GetUserIdAsync(user);
                var code = await _userManager.GenerateEmailConfirmationTokenAsync(user);
                code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
                EmailConfirmationUrl = Url.Page(
                    "/Account/ConfirmEmail",
                    pageHandler: null,
                    values: new { area = "Identity", userId = userId, code = code, returnUrl = returnUrl },
                    protocol: Request.Scheme);
            }

            return Page();
        }
    }
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ResetPassword.cshtml ================

@page
@model ResetPasswordModel
@{
    ViewData["Title"] = "Reset your password";
}

<div class="container d-flex justify-content-center">
    <div class="col-12 col-md-6 col-lg-5">

        <h2 class="text-center mt-4 mb-3">@ViewData["Title"]</h2>

        <form method="post" class="mt-3">
            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <input asp-for="Input.Code" type="hidden" />
            <input asp-for="Input.Email" type="hidden" />

            <div class="form-floating mb-3">
                <input asp-for="Input.Password"
                       class="form-control"
                       autocomplete="new-password"
                       aria-required="true"
                       placeholder="Please enter your new password." />
                <label asp-for="Input.Password" class="form-label">New password</label>
                <span asp-validation-for="Input.Password" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.ConfirmPassword"
                       class="form-control"
                       autocomplete="new-password"
                       aria-required="true"
                       placeholder="Please confirm your new password." />
                <label asp-for="Input.ConfirmPassword" class="form-label">Confirm new password</label>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>

            <button type="submit" class="w-100 btn btn-lg btn-primary">Reset</button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ResetPassword.cshtml.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using System.ComponentModel.DataAnnotations;
using System.Text;
using System.Threading.Tasks;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.AspNetCore.WebUtilities;

namespace MarketZone.Areas.Identity.Pages.Account
{
	[AllowAnonymous]
	public class ResetPasswordModel : PageModel
	{
		private readonly UserManager<User> _userManager;

		public ResetPasswordModel(UserManager<User> userManager)
		{
			_userManager = userManager;
		}

		[BindProperty]
		public InputModel Input { get; set; }

		public class InputModel
		{
			[Required]
			[EmailAddress]
			public string Email { get; set; }

			[Required]
			[StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
			[DataType(DataType.Password)]
			public string Password { get; set; }

			[DataType(DataType.Password)]
			[Display(Name = "Confirm password")]
			[Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
			public string ConfirmPassword { get; set; }

			[Required]
			public string Code { get; set; }
		}

		public IActionResult OnGet(string code = null, string email = null)
		{
			if (string.IsNullOrWhiteSpace(code))
				return BadRequest("A code must be supplied for password reset.");

			if (string.IsNullOrWhiteSpace(email))
				return BadRequest("An email must be supplied for password reset.");

			Input = new InputModel
			{
				Email = email.Trim(),
				Code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(code))
			};

			return Page();
		}

		public async Task<IActionResult> OnPostAsync()
		{
			if (!ModelState.IsValid)
				return Page();

			var user = await _userManager.FindByEmailAsync(Input.Email);

			if (user == null)
			{
				ModelState.AddModelError(string.Empty, "No account found with this email.");
				return Page();
			}

			var result = await _userManager.ResetPasswordAsync(user, Input.Code, Input.Password);

			if (result.Succeeded)
			{
				TempData["StatusMessage"] = "Your password has been reset. Please log in.";
				return RedirectToPage("./Login");
			}

			foreach (var error in result.Errors)
				ModelState.AddModelError(string.Empty, error.Description);

			return Page();
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ResetPasswordConfirmation.cshtml ================

@page
@model ResetPasswordConfirmationModel
@{
    // This page should never be shown.
    ViewData["Title"] = "Redirecting...";
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\ResetPasswordConfirmation.cshtml.cs ================

// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
#nullable disable

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace MarketZone.Areas.Identity.Pages.Account
{
	[AllowAnonymous]
	public class ResetPasswordConfirmationModel : PageModel
	{
		public IActionResult OnGet()
		{
			// In case something still redirects here, go to Login with a message.
			TempData["StatusMessage"] = "Password reset successful. Please log in.";
			return RedirectToPage("./Login");
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\VerifyEmailCode.cshtml ================

@page
@model MarketZone.Areas.Identity.Pages.Account.VerifyEmailCodeModel

@{
    ViewData["Title"] = "Verify Email";
}

<div class="d-flex justify-content-center align-items-center" style="min-height:70vh;">
    <div class="card p-4 shadow-sm"
         style="max-width:420px;width:100%;position:relative;">

        <h3 class="text-center mb-3">Verify your email</h3>

        <p class="text-center text-muted">
            We sent a 6-digit verification code to
            <strong>@Model.MaskedEmail</strong>
        </p>

        <form method="post" id="verifyForm">
            @Html.AntiForgeryToken()

            <input type="hidden" asp-for="Input.Email" />
            <input type="hidden" asp-for="Input.Code" id="otpCode" />

            <div class="d-flex justify-content-between mb-3">
                @for (int i = 0; i < 6; i++)
                {
                    <input type="text"
                           class="form-control text-center otp-input"
                           maxlength="1"
                           inputmode="numeric"
                           autocomplete="one-time-code"
                           style="width:48px;font-size:1.25rem;" />
                }
            </div>

            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="text-danger text-center mb-2">
                    @Model.ErrorMessage
                </div>
            }

            <button type="submit" class="btn btn-primary w-100">
                Verify code
            </button>
        </form>

        <!-- RESEND -->
        <div class="mt-3 text-center"
             style="position:relative; z-index:9999; pointer-events:auto;">

            <span id="resendBtn"
                  style="
                      display:inline-block;
                      padding:10px 16px;
                      border:2px solid #0d6efd;
                      border-radius:8px;
                      color:#0d6efd;
                      cursor:pointer;
                      user-select:none;
                  ">
                Resend code
            </span>

            <div id="cooldownText" class="text-muted mt-2"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const inputs = document.querySelectorAll('.otp-input');
            const hiddenCode = document.getElementById('otpCode');
            const resendBtn = document.getElementById('resendBtn');
            const cooldownText = document.getElementById('cooldownText');
            const email = document.querySelector('input[name="Input.Email"]').value;

            /* OTP INPUT */

            function syncCode() {
                hiddenCode.value = [...inputs].map(i => i.value).join('');
            }

            inputs.forEach((input, index) => {

                input.addEventListener('input', () => {
                    const value = input.value.replace(/[^0-9]/g, '');
                    input.value = value;

                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }

                    syncCode();
                });

                input.addEventListener('keydown', e => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', e => {
                    const pasted = e.clipboardData
                        .getData('text')
                        .replace(/\D/g, '')
                        .slice(0, 6);

                    if (!pasted) return;

                    inputs.forEach((box, i) => {
                        box.value = pasted[i] || '';
                    });

                    syncCode();
                    inputs[Math.min(pasted.length, 5)].focus();
                    e.preventDefault();
                });
            });

            /* RESEND */

            let cooldown = 0;
            let timer = null;

            resendBtn.onclick = async () => {
                if (cooldown > 0) return;

                startCooldown(30); // show immediately

                const response = await fetch('?handler=Resend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken':
                            document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ email })
                });

                if (!response.ok) {
                    stopCooldown(); // rollback if failed
                }
            };

            function startCooldown(seconds) {
                cooldown = seconds;

                resendBtn.style.pointerEvents = 'none';
                resendBtn.style.color = '#6c757d';
                resendBtn.style.borderColor = '#adb5bd';
                resendBtn.style.cursor = 'default';

                cooldownText.innerText = `Resend available in ${cooldown}s`;

                timer = setInterval(() => {
                    cooldown--;
                    cooldownText.innerText = `Resend available in ${cooldown}s`;

                    if (cooldown <= 0) {
                        stopCooldown();
                    }
                }, 1000);
            }

            function stopCooldown() {
                clearInterval(timer);
                cooldown = 0;

                resendBtn.style.pointerEvents = 'auto';
                resendBtn.style.color = '#0d6efd';
                resendBtn.style.borderColor = '#0d6efd';
                resendBtn.style.cursor = 'pointer';

                cooldownText.innerText = '';
            }
        });
    </script>
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Areas\Identity\Pages\Account\VerifyEmailCode.cshtml.cs ================

using System.Security.Cryptography;
using MarketZone.Data;
using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Areas.Identity.Pages.Account
{
	public class VerifyEmailCodeModel : PageModel
	{
		private readonly ApplicationDbContext _context;
		private readonly UserManager<User> _userManager;
		private readonly IEmailSender _emailSender;

		public VerifyEmailCodeModel(
			ApplicationDbContext context,
			UserManager<User> userManager,
			IEmailSender emailSender)
		{
			_context = context;
			_userManager = userManager;
			_emailSender = emailSender;

			Input = new InputModel();
		}

		[BindProperty(SupportsGet = true)]
		public InputModel Input { get; set; }

		public string MaskedEmail { get; set; } = string.Empty;

		public string? ErrorMessage { get; set; }

		public IActionResult OnGet(string? email)
		{
			if (string.IsNullOrWhiteSpace(email))
				return RedirectToPage("Register");

			Input.Email = email;
			MaskedEmail = MaskEmail(email);

			return Page();
		}

		public async Task<IActionResult> OnPostAsync()
		{
			MaskedEmail = MaskEmail(Input.Email);

			if (string.IsNullOrWhiteSpace(Input.Code) || Input.Code.Length != 6)
			{
				ErrorMessage = "Invalid or expired verification code.";
				return Page();
			}

			var user = await _userManager.FindByEmailAsync(Input.Email);
			if (user == null)
			{
				ErrorMessage = "Invalid or expired verification code.";
				return Page();
			}

			var codeEntry = await _context.EmailVerificationCodes
				.Where(c => c.UserId == user.Id)
				.OrderByDescending(c => c.CreatedAt)
				.FirstOrDefaultAsync();

			if (codeEntry == null ||
				codeEntry.ExpiresAt < DateTime.UtcNow ||
				codeEntry.Code != Input.Code)
			{
				ErrorMessage = "Invalid or expired verification code.";
				return Page();
			}

			user.EmailConfirmed = true;
			await _userManager.UpdateAsync(user);

			_context.EmailVerificationCodes.RemoveRange(
				_context.EmailVerificationCodes.Where(c => c.UserId == user.Id));

			await _context.SaveChangesAsync();

			return RedirectToPage("Login");
		}

		public async Task<IActionResult> OnPostResendAsync([FromBody] ResendRequest request)

		{
			if (string.IsNullOrWhiteSpace(request.Email))
				return BadRequest();

			var user = await _userManager.FindByEmailAsync(request.Email);
			if (user == null)
				return BadRequest();

			var lastCode = await _context.EmailVerificationCodes
				.Where(c => c.UserId == user.Id)
				.OrderByDescending(c => c.CreatedAt)
				.FirstOrDefaultAsync();

			if (lastCode != null &&
				lastCode.CreatedAt.AddSeconds(30) > DateTime.UtcNow)
				return BadRequest();

			_context.EmailVerificationCodes.RemoveRange(
				_context.EmailVerificationCodes.Where(c => c.UserId == user.Id));

			var newCode = RandomNumberGenerator.GetInt32(100000, 1000000)
		    .ToString();

			_context.EmailVerificationCodes.Add(new EmailVerificationCode
			{
				UserId = user.Id,
				Code = newCode,
				CreatedAt = DateTime.UtcNow,
				ExpiresAt = DateTime.UtcNow.AddMinutes(10)
			});

			await _context.SaveChangesAsync();

			await _emailSender.SendEmailAsync(
	                user.Email!,
	                "MarketZone – verification code",
	                $@"
                    <p>Your new verification code is <b>{newCode}</b>.</p>
                    <p>This code expires in <b>10 minutes</b>.</p>"
            );
			return new JsonResult(true);
		}

		private static string MaskEmail(string email)
		{
			var parts = email.Split('@');
			return $"{parts[0][0]}***@{parts[1][0]}***";
		}
	    public class ResendRequest
	    {
		public string Email { get; set; } = string.Empty;
