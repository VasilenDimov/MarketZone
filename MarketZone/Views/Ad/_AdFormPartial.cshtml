@model MarketZone.ViewModels.Ad.AdCreateModel

<!-- Title -->
<div class="mb-3">
    <label asp-for="Title"></label>
    <input asp-for="Title" class="form-control" />
    <span asp-validation-for="Title" class="text-danger"></span>
</div>

<!-- Description -->
<div class="mb-3">
    <label asp-for="Description"></label>
    <textarea asp-for="Description" class="form-control" rows="6"></textarea>
    <span asp-validation-for="Description" class="text-danger"></span>
</div>

<!-- Price + Currency -->
<div class="row mb-3">
    <div class="col-md-8">
        <label asp-for="Price"></label>
        <input asp-for="Price" class="form-control" />
        <span asp-validation-for="Price" class="text-danger"></span>
    </div>
    <div class="col-md-4">
        <label asp-for="Currency"></label>
        <select asp-for="Currency"
                class="form-select"
                asp-items="Html.GetEnumSelectList<MarketZone.Data.Enums.Currency>()">
        </select>
    </div>
</div>

<!-- Address -->
<div class="mb-3">
    <label asp-for="Address"></label>
    <input asp-for="Address" class="form-control" />
    <span asp-validation-for="Address" class="text-danger"></span>
</div>

<!-- Category picker -->
<div class="mb-3">
    <label>Category</label>

    <div class="border rounded p-2">
        <div class="d-flex align-items-center mb-2">
            <button type="button"
                    id="back-btn"
                    class="btn btn-sm btn-outline-secondary me-2"
                    style="display:none;">
                ← Back
            </button>

            <span id="breadcrumb" class="text-muted"></span>
        </div>

        <ul id="category-list" class="list-unstyled mb-0"></ul>
    </div>

    <input type="hidden" asp-for="CategoryId" />
    <span asp-validation-for="CategoryId" class="text-danger"></span>
</div>

<!-- Images -->
<div class="mb-3">
    <label class="d-block">Images (up to 10)</label>

    <input asp-for="Images"
           type="file"
           id="image-input"
           multiple
           accept="image/*"
           class="d-none" />

    <div id="image-grid" class="image-grid"></div>

    <span asp-validation-for="Images" class="text-danger"></span>
</div>

<!-- Condition -->
<div class="mb-3">
    <label class="form-label d-block">Condition</label>

    <div class="condition-toggle">
        <input type="radio" class="btn-check" asp-for="Condition" value="New" id="condition-new" />
        <label class="condition-btn" for="condition-new">New</label>

        <input type="radio" class="btn-check" asp-for="Condition" value="Used" id="condition-used" />
        <label class="condition-btn" for="condition-used">Used</label>
    </div>

    <span asp-validation-for="Condition" class="text-danger"></span>
</div>

<!-- Tags -->
<div class="mb-3">
    <label asp-for="Tags"></label>
    <input asp-for="Tags" class="form-control" placeholder="e.g. phone, samsung" />
</div>
@for (int i = 0; i < Model.ExistingImageUrls.Count; i++)
{
    <input type="hidden"
           name="ExistingImageUrls[@i]"
           value="@Model.ExistingImageUrls[i]" />
}
<script>
    document.addEventListener("DOMContentLoaded", () => {

        /* ===================== CATEGORY ===================== */
        const list = document.getElementById("category-list");
        const hiddenInput = document.getElementById("CategoryId");
        const backBtn = document.getElementById("back-btn");
        const breadcrumb = document.getElementById("breadcrumb");

        let parentStack = [];
        let breadcrumbStack = [];
        let currentParentId = null;

        if (list) {
            loadCategories(null);
        }

        function loadCategories(parentId, label = null) {
            if (label) breadcrumbStack.push(label);

            fetch(`/Ad/GetChildren?parentId=${parentId ?? ""}`)
                .then(r => r.json())
                .then(data => {
                    list.innerHTML = "";
                    currentParentId = parentId;

                    backBtn.style.display =
                        parentStack.length > 0 ? "inline-block" : "none";

                    breadcrumb.textContent = breadcrumbStack.join(" → ");

                    data.forEach(c => {
                        const li = document.createElement("li");
                        li.className = "p-2 border-bottom";
                        li.style.cursor = "pointer";
                        li.textContent = c.name;

                        if (c.hasChildren) {
                            li.innerHTML += " ➜";
                            li.onclick = () => {
                                parentStack.push(currentParentId);
                                loadCategories(c.id, c.name);
                            };
                        } else {
                            li.onclick = () => {
                                hiddenInput.value = c.id;
                                [...list.children].forEach(x =>
                                    x.classList.remove("bg-light"));
                                li.classList.add("bg-light");
                            };
                        }

                        list.appendChild(li);
                    });
                });
        }

        if (backBtn) {
            backBtn.onclick = () => {
                currentParentId = parentStack.pop();
                breadcrumbStack.pop();
                loadCategories(currentParentId);
            };
        }

        /* ===================== IMAGES ===================== */
        const grid = document.getElementById("image-grid");
        const input = document.getElementById("image-input");
        const errorSpan = document.querySelector("[data-valmsg-for='Images']");

        if (!grid || !input) return;

        const MAX_IMAGES = 10;
        let files = [];

        let existingImages = @Html.Raw(
                        System.Text.Json.JsonSerializer.Serialize(Model.ExistingImageUrls)
                );

        renderGrid();

        function renderGrid() {
            grid.innerHTML = "";

            /* EXISTING IMAGES */
            existingImages.forEach((url, index) => {
                const box = document.createElement("div");
                box.className = "image-box";

                box.innerHTML = `
                    <img src="${url}">
                    <div class="image-actions">
                        <button type="button" title="Remove">🗑</button>
                    </div>
                `;

                box.querySelector("button").onclick = e => {
                    e.stopPropagation();
                    existingImages.splice(index, 1);

                    const hiddenInputs = document.querySelectorAll(
                        "input[name^='ExistingImageUrls']"
                    );
                    hiddenInputs[index]?.remove();

                    renderGrid();
                };

                grid.appendChild(box);
            });

            /* NEW FILES */
            files.forEach((file, index) => {
                const box = document.createElement("div");
                box.className = "image-box";

                const reader = new FileReader();
                reader.onload = e => {
                    box.innerHTML = `
                        <img src="${e.target.result}">
                        <div class="image-actions">
                            <button type="button" title="Remove">🗑</button>
                        </div>
                    `;

                    box.querySelector("button").onclick = ev => {
                        ev.stopPropagation();
                        files.splice(index, 1);
                        syncInputFiles();
                        renderGrid();
                    };
                };

                reader.readAsDataURL(file);
                grid.appendChild(box);
            });

            /* EMPTY SLOTS */
            const used = existingImages.length + files.length;
            for (let i = used; i < MAX_IMAGES; i++) {
                const empty = document.createElement("div");
                empty.className = "image-box";
                empty.innerHTML = "<span>+</span>";
                empty.onclick = () => input.click();
                grid.appendChild(empty);
            }

            validateImages();
        }

        input.addEventListener("change", e => {
            for (let file of e.target.files) {
                if (files.length + existingImages.length < MAX_IMAGES) {
                    files.push(file);
                }
            }

            input.value = "";
            syncInputFiles();
            renderGrid();
        });

        function syncInputFiles() {
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            input.files = dt.files;
        }

        function validateImages() {
            const count = existingImages.length + files.length;
            errorSpan.textContent =
                count === 0 ? "At least one image is required." : "";
        }
    });
</script>
