@using MarketZone.Data.Enums
@using System.Security.Claims
@model MarketZone.ViewModels.Ad.AdDetailsModel

@{
    ViewData["Title"] = Model.Title;

    bool isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    string? currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);

    bool isOwner = isAuthenticated && currentUserId == Model.SellerId;
    bool isModeratorOrAdmin = isAuthenticated && (User.IsInRole("Admin") || User.IsInRole("Moderator"));

    // 🔥 This is what preserves search + page from Moderation
    string? returnUrl = Context.Request.Query["returnUrl"];
}

@Html.AntiForgeryToken()

<h2>@Model.Title</h2>

<div class="text-muted mb-3">
    Posted on @Model.CreatedOn.ToString("dd MMM yyyy")
</div>

@if (isModeratorOrAdmin && Model.Status == AdStatus.Pending)
{
    <div class="alert alert-info d-flex align-items-center justify-content-between gap-3">
        <div>
            <strong>Moderation:</strong> You can approve or reject this ad from here.
        </div>

        <div class="d-flex gap-2">
            <form method="post"
                  asp-controller="Moderation"
                  asp-action="Approve"
                  class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="returnUrl" value="@returnUrl" />
                <button class="btn btn-success" type="submit">Approve</button>
            </form>

            <button type="button"
                    class="btn btn-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#rejectModal"
                    data-adid="@Model.Id">
                Reject
            </button>
        </div>
    </div>
}

<div class="row">
    <!-- Images -->
    <div class="col-md-6">
        <img id="main-image"
             src="@Model.ImageUrls.First()"
             class="img-fluid rounded mb-3" />

        <div class="d-flex gap-2 flex-wrap">
            @foreach (var img in Model.ImageUrls)
            {
                <img src="@img"
                     class="img-thumbnail"
                     style="width:80px;height:80px;object-fit:cover;cursor:pointer"
                     onclick="document.getElementById('main-image').src='@img'" />
            }
        </div>
    </div>

    <!-- Details -->
    <div class="col-md-6">
        <h3 class="text-primary">
            @Model.Price @(Model.Currency == Currency.EUR ? "€" : "$")
        </h3>

        <span class="badge bg-secondary mb-3">
            @Model.Condition
        </span>

        @if (!isOwner)
        {
            <div class="d-flex gap-2 mb-3">

                @if (isAuthenticated)
                {
                    <a asp-controller="Messages"
                       asp-action="Chat"
                       asp-route-adId="@Model.Id"
                       asp-route-otherUserId="@Model.SellerId"
                       class="btn btn-outline-primary">
                        💬 Message Seller
                    </a>
                }
                else
                {
                    <button type="button"
                            class="btn btn-outline-primary"
                            onclick="requireLogin()">
                        💬 Message Seller
                    </button>
                }

                @if (isAuthenticated)
                {
                    <button id="favorite-btn"
                            type="button"
                            class="btn btn-outline-danger"
                            data-ad-id="@Model.Id">
                        @(Model.IsFavorite ? "❤️ Remove from Favorites" : "🤍 Add to Favorites")
                    </button>
                }
                else
                {
                    <button type="button"
                            class="btn btn-outline-danger"
                            onclick="requireLogin()">
                        🤍 Add to Favorites
                    </button>
                }
            </div>
        }

        <p style="white-space: pre-line; word-break: break-word;">
            @Model.Description
        </p>

        <p>
            <strong>Category:</strong> @Model.CategoryPath
        </p>

        <p>
            <strong>Address:</strong> @Model.Address
        </p>

        @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
        {
            <div style="height:200px;border-radius:8px;border:1px solid #dee2e6;overflow:hidden;" class="mb-3">
                <div id="details-map" style="height:100%;width:100%;"></div>
            </div>
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const map = L.map("details-map", { scrollWheelZoom: false, dragging: false });
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: "© OpenStreetMap"
                    }).addTo(map);
                    L.marker([@Model.Latitude, @Model.Longitude]).addTo(map);
                    map.setView([@Model.Latitude, @Model.Longitude], 14);
                });
            </script>
        }

        <p class="d-flex align-items-center gap-2">
            <strong>Seller:</strong>

            <a asp-controller="User"
               asp-action="Profile"
               asp-route-id="@Model.SellerId"
               class="d-flex align-items-center gap-2 text-decoration-none">

                <img src="@Model.SellerProfilePictureUrl"
                     class="rounded-circle"
                     style="width:32px;height:32px;object-fit:cover;" />

                <span>@Model.SellerName</span>
            </a>
        </p>
    </div>
</div>

@if (isModeratorOrAdmin && Model.Status == AdStatus.Pending)
{
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" asp-controller="Moderation" asp-action="Reject">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="returnUrl" value="@returnUrl" />

                    <div class="modal-header">
                        <h5 class="modal-title">Reject ad</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <label class="form-label">Reason</label>
                        <textarea name="reason" class="form-control" rows="3" maxlength="300"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script>
    window.adDetailsConfig = {
        adId: @Model.Id,
        isAuthenticated: @(isAuthenticated.ToString().ToLower()),
        isOwner: @(isOwner.ToString().ToLower()),
        antiForgeryToken:
            document.querySelector('input[name="__RequestVerificationToken"]').value
    };
</script>

@section Scripts {
    <script src="~/js/ad-details.js" asp-append-version="true"></script>
}