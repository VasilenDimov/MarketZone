@using MarketZone.ViewModels.Message
@model ChatViewModel

@{
    DateTime? lastDate = null;
}

<h4>Chat with @Model.OtherUserName</h4>

<!-- Ad preview -->
<a asp-controller="Ad"
   asp-action="Details"
   asp-route-id="@Model.AdId"
   class="chat-ad-preview">

    <img src="@Model.AdImageUrl" class="chat-ad-image" />
    <div class="chat-ad-info">
        <div class="chat-ad-title">@Model.AdTitle</div>
        <div class="chat-ad-link">View ad details</div>
    </div>
</a>

<!-- CHAT -->
<div id="chat-box" class="chat-box">
    @foreach (var msg in Model.Messages)
    {
        bool isMine = msg.SenderId == Model.CurrentUserId;

        if (lastDate == null || lastDate.Value.Date != msg.SentOn.Date)
        {
            <div class="chat-date">@msg.SentOn.ToString("dd MMM yyyy")</div>
            lastDate = msg.SentOn;
        }

        <div class="chat-message @(isMine ? "mine" : "theirs")">
            @if (!isMine)
            {
                <img src="/images/default-avatar.png" class="chat-avatar" />
            }

            <div class="chat-bubble">

                @if (msg.ImageUrls.Any())
                {
                    <div class="chat-images">
                        @for (int i = 0; i < msg.ImageUrls.Count; i++)
                        {
                            <img src="@msg.ImageUrls[i]"
                                 class="chat-image"
                                 onclick='openImageGallery(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(msg.ImageUrls)), @i)' />
                        }
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(msg.Content))
                {
                    <div class="chat-text">@msg.Content</div>
                }

                <div class="chat-time">@msg.SentOn.ToString("HH:mm")</div>
            </div>
        </div>
    }
</div>

<!-- input -->
<div class="chat-footer">

    <div id="imagePreview" class="chat-image-preview"></div>

    <div class="chat-input-wrapper">

        <label for="imageInput" class="chat-image-btn">🖼</label>
        <input type="file" id="imageInput" multiple hidden />

        <input id="msgInput" class="form-control" placeholder="Type message..." />

        <button id="sendBtn" type="button" class="btn btn-primary">Send</button>
    </div>
</div>

<!-- image viewer -->
<div id="imageViewer" class="image-viewer hidden">
    <div class="image-viewer-header">
        <span id="imageCounter"></span>
        <div>
            <!--id added -->
            <button id="downloadBtn" title="Download">⬇</button>
            <button onclick="closeViewer()">✕</button>
        </div>
    </div>

    <button class="nav left" onclick="prevImage()">‹</button>
    <img id="viewerImage" />
    <button class="nav right" onclick="nextImage()">›</button>
</div>

<script>
    window.chatConfig = {
        chatId: "@Model.ChatId",
        adId: @Model.AdId,
        currentUserId: "@Model.CurrentUserId"
    };
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/js/chat.js" asp-append-version="true"></script>
}
