@using MarketZone.ViewModels.Message
@model ChatViewModel

@{
    DateTime? lastDate = null;
}

<h4>Chat with @Model.OtherUserName</h4>

<!-- Ad preview -->
<a asp-controller="Ad"
   asp-action="Details"
   asp-route-id="@Model.AdId"
   class="chat-ad-preview">

    <img src="@Model.AdImageUrl" class="chat-ad-image" />
    <div class="chat-ad-info">
        <div class="chat-ad-title">@Model.AdTitle</div>
        <div class="chat-ad-link">View ad details</div>
    </div>
</a>

<!-- CHAT -->
<div id="chat-box" class="chat-box">
    @foreach (var msg in Model.Messages)
    {
        bool isMine = msg.SenderId == Model.CurrentUserId;

        if (lastDate == null || lastDate.Value.Date != msg.SentOn.Date)
        {
            <div class="chat-date">@msg.SentOn.ToString("dd MMM yyyy")</div>
            lastDate = msg.SentOn;
        }

        <div class="chat-message @(isMine ? "mine" : "theirs")">
            @if (!isMine)
            {
                <img src="/images/default-profile.png" class="chat-avatar" />
            }

            <div class="chat-bubble">

                @if (msg.ImageUrls.Any())
                {
                    <div class="chat-images">
                        @for (int i = 0; i < msg.ImageUrls.Count; i++)
                        {
                            <img src="@msg.ImageUrls[i]"
                                 class="chat-image"
                                 onclick='openImageGallery(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(msg.ImageUrls)), @i)' />
                        }
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(msg.Content))
                {
                    <div class="chat-text">@msg.Content</div>
                }

                <div class="chat-time">@msg.SentOn.ToString("HH:mm")</div>
            </div>
        </div>
    }
</div>

<!-- ===== INPUT (STRUCTURALLY FIXED, NOTHING ELSE TOUCHED) ===== -->
<div class="chat-footer">

    <div id="imagePreview" class="chat-image-preview"></div>

    <div class="chat-input-wrapper">

        <label for="imageInput" class="chat-image-btn">🖼</label>
        <input type="file" id="imageInput" multiple hidden />

        <input id="msgInput" class="form-control" placeholder="Type message..." />

        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

<!-- IMAGE VIEWER -->
<div id="imageViewer" class="image-viewer hidden">
    <div class="image-viewer-header">
        <span id="imageCounter"></span>
        <div>
            <!-- ONLY CHANGE HERE: id added -->
            <button id="downloadBtn" title="Download">⬇</button>
            <button onclick="closeViewer()">✕</button>
        </div>
    </div>

    <button class="nav left" onclick="prevImage()">‹</button>
    <img id="viewerImage" />
    <button class="nav right" onclick="nextImage()">›</button>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const chatBox = document.getElementById("chat-box");
        const chatId = "@Model.ChatId";
        const adId = @Model.AdId;
        const currentUserId = "@Model.CurrentUserId";

        const imageInput = document.getElementById("imageInput");
        const imagePreview = document.getElementById("imagePreview");
        const msgInput = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");

        let selectedImages = [];

        imageInput.addEventListener("change", () => {
            selectedImages = Array.from(imageInput.files);
            renderPreview();
        });

        function renderPreview() {
            imagePreview.innerHTML = "";
            selectedImages.forEach((file, i) => {
                const r = new FileReader();
                r.onload = e => {
                    imagePreview.innerHTML += `
                        <div class="preview-image-wrapper">
                            <img src="${e.target.result}" />
                            <span class="remove-image" onclick="removeImage(${i})">✕</span>
                        </div>`;
                };
                r.readAsDataURL(file);
            });
        }

        window.removeImage = i => {
            selectedImages.splice(i, 1);
            renderPreview();
        };

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.start().then(() => {
            connection.invoke("JoinChat", chatId);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        connection.on("ReceiveMessage", (senderId, content, imageUrls, sentOn) => {
            const mine = senderId === currentUserId;

            const div = document.createElement("div");
            div.className = `chat-message ${mine ? "mine" : "theirs"}`;

            div.innerHTML = `
                ${!mine ? `<img src="/images/default-profile.png" class="chat-avatar" />` : ""}
                <div class="chat-bubble">
                    ${imageUrls.length ? `
                        <div class="chat-images">
                            ${imageUrls.map((i, x) =>
                                `<img src="${i}" class="chat-image"
                                 onclick='openImageGallery(${JSON.stringify(imageUrls)}, ${x})' />`
                            ).join("")}
                        </div>` : ""}
                    ${content ? `<div class="chat-text">${content}</div>` : ""}
                    <div class="chat-time">${new Date(sentOn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>`;

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        sendBtn.addEventListener("click", async () => {
            if (!msgInput.value && !selectedImages.length) return;

            const urls = [];
            for (const f of selectedImages) {
                const fd = new FormData();
                fd.append("image", f);
                const r = await fetch("/Messages/UploadChatImage", { method: "POST", body: fd });
                const d = await r.json();
                urls.push(d.imageUrl);
            }

            await connection.invoke("SendMessage", adId, chatId, msgInput.value, urls);

            msgInput.value = "";
            selectedImages = [];
            imagePreview.innerHTML = "";
        });

        /* IMAGE VIEWER */
        let gallery = [], index = 0;

        function openImageGallery(images, i) {
            gallery = images;
            index = i;
            document.getElementById("imageViewer").classList.remove("hidden");
            updateViewer();
        }

        function closeViewer() {
            document.getElementById("imageViewer").classList.add("hidden");
        }

        function updateViewer() {
            document.getElementById("viewerImage").src = gallery[index];
            document.getElementById("imageCounter").textContent = `${index + 1} / ${gallery.length}`;
        }

        function prevImage() {
            if (index > 0) { index--; updateViewer(); }
        }

        function nextImage() {
            if (index < gallery.length - 1) { index++; updateViewer(); }
        }

        /* DOWNLOAD (ONLY ADDITION) */
        document.getElementById("downloadBtn").addEventListener("click", () => {
            if (!gallery.length) return;

            const url = gallery[index];
            const name = url.split("/").pop().split("?")[0] || "image.jpg";

            const a = document.createElement("a");
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
}
