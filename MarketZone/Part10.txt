			try
			{
				await next(context);
			}
			catch (ArgumentException ex)
			{
				logger.LogWarning(ex, ex.Message);
				await HandleExceptionAsync(context, HttpStatusCode.BadRequest, ex.Message);
			}
			catch (InvalidOperationException ex)
			{
				logger.LogWarning(ex, ex.Message);
				await HandleExceptionAsync(context, HttpStatusCode.BadRequest, ex.Message);
			}
			catch (Exception ex)
			{
				logger.LogError(ex, "Unhandled exception");
				await HandleExceptionAsync(context, HttpStatusCode.InternalServerError,
					"An unexpected error occurred.");
			}
		}

		private static async Task HandleExceptionAsync(
			HttpContext context,
			HttpStatusCode statusCode,
			string message)
		{
			bool isAjax = context.Request.Headers["X-Requested-With"] == "XMLHttpRequest"
					   || context.Request.Headers["Accept"].ToString().Contains("application/json");

			if (isAjax)
			{
				// API / AJAX call → return JSON 
				context.Response.StatusCode = (int)statusCode;
				context.Response.ContentType = "application/json";
				await context.Response.WriteAsync(
					JsonSerializer.Serialize(new { error = message }));
			}
			else
			{
				// Browser navigation → redirect to error page 
				context.Response.Redirect($"/Home/Error?message={Uri.EscapeDataString(message)}");
			}
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Middlewares\UserOnlineMiddleware.cs ================

using MarketZone.Data.Models;
using Microsoft.AspNetCore.Identity;

namespace MarketZone.Middlewares
{
	public class UserOnlineMiddleware
	{
		private readonly RequestDelegate _next;

		public UserOnlineMiddleware(RequestDelegate next)
		{
			_next = next;
		}

		public async Task InvokeAsync(
			HttpContext context,
			UserManager<User> userManager)
		{
			if (context.User?.Identity?.IsAuthenticated == true)
			{
				var user = await userManager.GetUserAsync(context.User);

				if (user != null)
				{
					var now = DateTime.UtcNow;

					if (user.LastOnlineOn == null ||
						now - user.LastOnlineOn > TimeSpan.FromMinutes(2))
					{
						user.LastOnlineOn = now;
						await userManager.UpdateAsync(user);
					}
				}
			}

			await _next(context);
		}
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Email\EmailVerificationCleanupService.cs ================

using MarketZone.Data;
using Microsoft.EntityFrameworkCore;

public class EmailVerificationCleanupService : BackgroundService
{
	private readonly IServiceScopeFactory _scopeFactory;

	public EmailVerificationCleanupService(IServiceScopeFactory scopeFactory)
	{
		_scopeFactory = scopeFactory;
	}

	protected override async Task ExecuteAsync(CancellationToken stoppingToken)
	{
		while (!stoppingToken.IsCancellationRequested)
		{
			using var scope = _scopeFactory.CreateScope();
			var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

			await context.EmailVerificationCodes
	              .Where(c => c.ExpiresAt < DateTime.UtcNow)
	              .ExecuteDeleteAsync(stoppingToken);

			// Run every 5 minutes
			await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Email\SendGridEmailSender.cs ================

using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using SendGrid;
using SendGrid.Helpers.Mail;

namespace MarketZone.Services.Implementations
{
	public class SendGridEmailSender : IEmailSender
	{
		private readonly IConfiguration _configuration;
		private readonly ILogger<SendGridEmailSender> _logger;

		public SendGridEmailSender(
			IConfiguration configuration,
			ILogger<SendGridEmailSender> logger)
		{
			_configuration = configuration;
			_logger = logger;
		}

		public async Task SendEmailAsync(string email, string subject, string htmlMessage)
		{
			var apiKey = _configuration["SendGrid:ApiKey"];
			var fromEmail = _configuration["SendGrid:FromEmail"];
			var fromName = _configuration["SendGrid:FromName"] ?? "MarketZone";

			if (string.IsNullOrWhiteSpace(apiKey))
				throw new InvalidOperationException("SendGrid API key is missing (SendGrid:ApiKey).");

			if (string.IsNullOrWhiteSpace(fromEmail))
				throw new InvalidOperationException("SendGrid FromEmail is missing (SendGrid:FromEmail).");

			if (string.IsNullOrWhiteSpace(email))
				throw new ArgumentException("Recipient email is empty.", nameof(email));

			// Create client per call is OK, but we can keep it here.
			// (If you want, you can inject ISendGridClient later.)
			var client = new SendGridClient(apiKey);

			var from = new EmailAddress(fromEmail, fromName);
			var to = new EmailAddress(email);

			var msg = MailHelper.CreateSingleEmail(
				from,
				to,
				subject,
				plainTextContent: StripHtml(htmlMessage),
				htmlContent: htmlMessage
			);

			// Retries for transient failures (429, 5xx)
			const int maxAttempts = 3;
			var delay = TimeSpan.FromMilliseconds(400);

			for (int attempt = 1; attempt <= maxAttempts; attempt++)
			{
				try
				{
					var response = await client.SendEmailAsync(msg);

					// 202 is success for SendGrid
					if ((int)response.StatusCode < 400)
					{
						_logger.LogInformation(
							"SendGrid email accepted. To={To} Subject={Subject} Status={Status}",
							email, subject, response.StatusCode);

						return;
					}

					var body = await response.Body.ReadAsStringAsync();

					_logger.LogWarning(
						"SendGrid email failed. Attempt {Attempt}/{MaxAttempts}. To={To} Status={Status} Body={Body}",
						attempt, maxAttempts, email, response.StatusCode, body);

					// Retry only for rate limit / transient server issues
					if (response.StatusCode == System.Net.HttpStatusCode.TooManyRequests ||
						(int)response.StatusCode >= 500)
					{
						if (attempt < maxAttempts)
						{
							await Task.Delay(delay);
							delay = TimeSpan.FromMilliseconds(delay.TotalMilliseconds * 2);
							continue;
						}
					}

					throw new InvalidOperationException(
						$"SendGrid failed: {response.StatusCode} - {body}");
				}
				catch (Exception ex) when (attempt < maxAttempts)
				{
					// Network / transient exception: retry
					_logger.LogWarning(
						ex,
						"SendGrid exception on attempt {Attempt}/{MaxAttempts}. To={To}",
						attempt, maxAttempts, email);

					await Task.Delay(delay);
					delay = TimeSpan.FromMilliseconds(delay.TotalMilliseconds * 2);
				}
			}

			// If we get here, all attempts failed (should have thrown above)
			throw new InvalidOperationException("SendGrid failed after retries.");
		}

		private static string StripHtml(string html)
		{
			if (string.IsNullOrWhiteSpace(html)) return string.Empty;
			// keep it simple; you only need a fallback text body
			return html
				.Replace("<br>", "\n", StringComparison.OrdinalIgnoreCase)
				.Replace("<br/>", "\n", StringComparison.OrdinalIgnoreCase)
				.Replace("<br />", "\n", StringComparison.OrdinalIgnoreCase)
				.Replace("&nbsp;", " ", StringComparison.OrdinalIgnoreCase);
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\AdService.cs ================

using MarketZone.Data;
using MarketZone.Data.Models;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Ad;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class AdService : IAdService
	{
		private readonly ApplicationDbContext context;
		private readonly IImageService imageService;
		private readonly ICategoryHierarchyService categoryHierarchyService;

		public AdService(ApplicationDbContext context, IImageService imageService,
			ICategoryHierarchyService categoryHierarchyService)
		{
			this.context = context;
			this.imageService = imageService;
			this.categoryHierarchyService = categoryHierarchyService;
		}

		public async Task<int> CreateAsync(AdCreateModel model, string userId)
		{
			if (model.Images == null || model.Images.Count == 0)
			{
				throw new InvalidOperationException("At least one image is required.");
			}

			// Validate that the category exists
			var categoryExists = await context.Categories
				.AnyAsync(c => c.Id == model.CategoryId);

			if (!categoryExists)
			{
				throw new InvalidOperationException("The selected category does not exist.");
			}

			var ad = new Ad
			{
				Title = model.Title,
				Description = model.Description,
				Price = model.Price,
				Currency = model.Currency,
				Address = model.Address,
				Latitude = model.Latitude,
				Longitude = model.Longitude,
				CategoryId = model.CategoryId!.Value,
				Condition = model.Condition,
				UserId = userId,
				CreatedOn = DateTime.UtcNow
			};

			//Images
			foreach (var image in model.Images)
			{
				var imageUrl = await imageService.UploadAdImageAsync(image);

				ad.Images.Add(new AdImage
				{
					ImageUrl = imageUrl
				});
			}

			//Tags (optional, max 20)
			if (!string.IsNullOrWhiteSpace(model.Tags))
			{
				var tagNames = model.Tags
					.Split(',', StringSplitOptions.RemoveEmptyEntries)
					.Select(t => t.Trim().ToLower())
					.Distinct()
					.Take(20);

				foreach (var tagName in tagNames)
				{
					var tag = await context.Tags
						.FirstOrDefaultAsync(t => t.Name == tagName)
						?? new Tag { Name = tagName };

					ad.AdTags.Add(new AdTag
					{
						Tag = tag
					});
				}
			}

			await context.Ads.AddAsync(ad);
			await context.SaveChangesAsync();

			return ad.Id;
		}

		public async Task<AdDetailsModel?> GetDetailsAsync(int id, string? userId)
		{
			return await context.Ads
				.AsNoTracking()
				.Where(a => a.Id == id)
				.Select(a => new AdDetailsModel
				{
					Id = a.Id,
					Title = a.Title,
					Description = a.Description,
					Price = a.Price,
					Currency = a.Currency,
					Condition = a.Condition,
					Address = a.Address,
					Latitude = a.Latitude,
					Longitude = a.Longitude,
					CreatedOn = a.CreatedOn,
					SellerId = a.UserId,

					SellerName = a.User.UserName!,
					CategoryPath = a.Category.ParentCategory != null
						? a.Category.ParentCategory.Name + " → " + a.Category.Name
						: a.Category.Name,

					ImageUrls = a.Images
						.OrderBy(i => i.Id)
						.Select(i => i.ImageUrl)
						.ToList(),

					IsFavorite = userId != null &&
						context.Favorites.Any(f =>
							f.AdId == a.Id && f.UserId == userId)
				})
				.FirstOrDefaultAsync();
		}

		public async Task<IEnumerable<AdListItemViewModel>> GetMyAdsAsync(string userId)
		{
			return await context.Ads
				.AsNoTracking()
				.Where(a => a.UserId == userId)
				.OrderByDescending(a => a.CreatedOn)
				.Select(a => new AdListItemViewModel
				{
					Id = a.Id,
					Title = a.Title,
					Price = a.Price,
					Currency = a.Currency,
					CreatedOn = a.CreatedOn,
					MainImageUrl = a.Images
		                  .OrderBy(i => i.Id)
		                  .Select(i => i.ImageUrl)
		                  .FirstOrDefault(),
					CanEdit = true
				})
				.ToListAsync();
		}
		public async Task<AdCreateModel?> GetEditModelAsync(int adId, string userId)
		{
			var ad = await context.Ads
				.AsNoTracking()
				.Include(a => a.Images)
				.Include(a => a.AdTags)
				.ThenInclude(at => at.Tag)
				.FirstOrDefaultAsync(a => a.Id == adId && a.UserId == userId);

			if (ad == null)
				return null;

			return new AdCreateModel
			{
				Id = ad.Id,
				Title = ad.Title,
				Description = ad.Description,
				Price = ad.Price,
				Currency = ad.Currency,
				Condition = ad.Condition,
				Address = ad.Address,
				Latitude = ad.Latitude,
				Longitude = ad.Longitude,
				CategoryId = ad.CategoryId,
				Tags = string.Join(", ", ad.AdTags.Select(t => t.Tag.Name)),
				ExistingImageUrls = ad.Images
	             .OrderBy(i => i.Id)
	             .Select(i => i.ImageUrl)
                 .ToList()
			};

		}
		public async Task<bool> UpdateAsync(AdCreateModel model, string userId)
		{
			var ad = await context.Ads
				.Include(a => a.Images)
				.Include(a => a.AdTags)
					.ThenInclude(at => at.Tag)
				.FirstOrDefaultAsync(a => a.Id == model.Id && a.UserId == userId);

			if (ad == null)
				return false;

			// Update scalar fields
			ad.Title = model.Title;
			ad.Description = model.Description;
			ad.Price = model.Price;
			ad.Currency = model.Currency;
			ad.Condition = model.Condition;
			ad.Address = model.Address;
			ad.Latitude = model.Latitude;
			ad.Longitude = model.Longitude;
			ad.CategoryId = model.CategoryId!.Value;

			// IMAGES

			// Remove images that user removed in UI
			var imagesToRemove = ad.Images
				.Where(i => !model.ExistingImageUrls.Contains(i.ImageUrl))
				.ToList();

			foreach (var img in imagesToRemove)
			{
				ad.Images.Remove(img);

				await imageService.DeleteImageAsync(img.ImageUrl);
			}

			// Add newly uploaded images
			foreach (var image in model.Images)
			{
				var imageUrl = await imageService.UploadAdImageAsync(image);
				ad.Images.Add(new AdImage { ImageUrl = imageUrl });
			}

			// Enforce at least one image AFTER merge
			if (!ad.Images.Any())
				throw new InvalidOperationException("At least one image is required.");

			// TAGS

			ad.AdTags.Clear();

			if (!string.IsNullOrWhiteSpace(model.Tags))
			{
				var tags = model.Tags
					.Split(',', StringSplitOptions.RemoveEmptyEntries)
					.Select(t => t.Trim().ToLower())
					.Distinct();

				foreach (var tagName in tags)
				{
					var tag = await context.Tags
						.FirstOrDefaultAsync(t => t.Name == tagName)
						?? new Tag { Name = tagName };

					ad.AdTags.Add(new AdTag { Tag = tag });
				}
			}

			await context.SaveChangesAsync();
			return true;
		}
		public async Task<bool> DeleteAsync(int adId, string userId)
		{
			var ad = await context.Ads
				.Include(a => a.Images)
				.FirstOrDefaultAsync(a => a.Id == adId && a.UserId == userId);

			if (ad == null)
				return false;

			// Delete physical images
			foreach (var img in ad.Images.ToList())
			{
				ad.Images.Remove(img);
				await imageService.DeleteImageAsync(img.ImageUrl);
			}

			context.Ads.Remove(ad);
			await context.SaveChangesAsync();

			return true;
		}
		public async Task<AdSearchViewModel> SearchAsync(string? search,
	    string? address,int? categoryId, decimal? minPrice, decimal? maxPrice,
		string? tags,string? sort, int page, string? userId)
		{
			const int PageSize = 21;

			var query = context.Ads.AsNoTracking().AsQueryable();

			// Exclude user's own ads
			if (!string.IsNullOrEmpty(userId))
				query = query.Where(a => a.UserId != userId);

			// Search (title)
			if (!string.IsNullOrWhiteSpace(search))
				query = query.Where(a => a.Title.Contains(search));

			// Address scaling: split into tokens and require all tokens to be present (order independent)
			if (!string.IsNullOrWhiteSpace(address))
			{
				var tokens = address
					.ToLower()
					.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries)
					.Distinct()
					.ToList();

				foreach (var t in tokens)
				{
					var token = t;
					query = query.Where(a => a.Address.ToLower().Contains(token));
				}
			}

			// Category: include selected + all descendants
			if (categoryId.HasValue)
			{
				var allowedCategoryIds = await categoryHierarchyService
				.GetDescendantCategoryIdsAsync(categoryId.Value);
				query = query.Where(a => allowedCategoryIds.Contains(a.CategoryId));
			}

			// Price
			if (minPrice.HasValue)
				query = query.Where(a => a.Price >= minPrice.Value);

			if (maxPrice.HasValue)
				query = query.Where(a => a.Price <= maxPrice.Value);

			// Tags (up to 10, OR match): AdTags -> Tag.Name
			if (!string.IsNullOrWhiteSpace(tags))
			{
				var tagList = tags
					.Split(',', StringSplitOptions.RemoveEmptyEntries)
					.Select(t => t.Trim().ToLower())
					.Where(t => !string.IsNullOrWhiteSpace(t))
					.Distinct()
					.Take(10)
					.ToList();

				if (tagList.Count > 0)
				{
					query = query.Where(a => a.AdTags.Any(at => tagList.Contains(at.Tag.Name.ToLower())));
				}
			}

			// Sorting
			query = sort switch
			{
				"oldest" => query.OrderBy(a => a.CreatedOn),
				"price_asc" => query.OrderBy(a => a.Price),
				"price_desc" => query.OrderByDescending(a => a.Price),
				_ => query.OrderByDescending(a => a.CreatedOn)
			};

			var totalAds = await query.CountAsync();

			var ads = await query
				.Skip((page - 1) * PageSize)
				.Take(PageSize)
				.Select(a => new AdListItemViewModel
				{
					Id = a.Id,
					Title = a.Title,
					Price = a.Price,
					Currency = a.Currency,
					CreatedOn = a.CreatedOn,
					MainImageUrl = a.Images
						.OrderBy(i => i.Id)
						.Select(i => i.ImageUrl)
						.FirstOrDefault()
				})
				.ToListAsync();

			string? categoryName = null;
			if (categoryId.HasValue)
			{
				categoryName = await context.Categories
					.AsNoTracking()
					.Where(c => c.Id == categoryId.Value)
					.Select(c => c.Name)
					.FirstOrDefaultAsync();
			}

			return new AdSearchViewModel
			{
				SearchTerm = search,
				Address = address,
				CategoryId = categoryId,
				CategoryName = categoryName,
				MinPrice = minPrice,
				MaxPrice = maxPrice,
				Tags = tags,
				Sort = sort,
				CurrentPage = page,
				TotalPages = (int)Math.Ceiling(totalAds / (double)PageSize),
				Ads = ads
			};
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\CategoryHierarchyService.cs ================

using MarketZone.Data;
using MarketZone.Services.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class CategoryHierarchyService : ICategoryHierarchyService
	{
		private readonly ApplicationDbContext context;

		public CategoryHierarchyService(ApplicationDbContext context)
		{
			this.context = context;
		}

		public async Task<List<int>> GetDescendantCategoryIdsAsync(int rootId)
		{
			var categories = await context.Categories
				.AsNoTracking()
				.Select(c => new { c.Id, c.ParentCategoryId })
				.ToListAsync();

			var result = new HashSet<int>();
			var queue = new Queue<int>();

			queue.Enqueue(rootId);
			result.Add(rootId);

			while (queue.Count > 0)
			{
				var current = queue.Dequeue();

				var children = categories
					.Where(c => c.ParentCategoryId == current)
					.Select(c => c.Id);

				foreach (var child in children)
				{
					if (result.Add(child))
						queue.Enqueue(child);
				}
			}

			return result.ToList();
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\CategoryService.cs ================

using MarketZone.Data;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Category;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class CategoryService : ICategoryService
	{
		private readonly ApplicationDbContext context;

		public CategoryService(ApplicationDbContext context)
		{
			this.context = context;
		}

		public async Task<IEnumerable<CategorySelectModel>> GetAllAsync()
		{
			return await context.Categories
				.AsNoTracking()
				.OrderBy(c => c.Name)
				.Select(c => new CategorySelectModel
				{
					Id = c.Id,
					Name = c.Name
				})
				.ToListAsync();
		}
		public async Task<IEnumerable<CategoryChildDto>> GetChildrenAsync(int? parentId)
		{
			return await context.Categories
				.AsNoTracking()
				.Where(c => c.ParentCategoryId == parentId)
				.Select(c => new CategoryChildDto
				{
					Id = c.Id,
					Name = c.Name,
					HasChildren = context.Categories.Any(sc => sc.ParentCategoryId == c.Id)
				})
				.ToListAsync();
		}

	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\FavoriteService.cs ================

using MarketZone.Data;
using MarketZone.Data.Models;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Ad;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class FavoriteService : IFavoriteService
	{
		private readonly ApplicationDbContext context;

		public FavoriteService(ApplicationDbContext context)
		{
			this.context = context;
		}

		public async Task<bool> ToggleAsync(int adId, string userId)
		{
			bool adExists = await context.Ads.AnyAsync(a => a.Id == adId);

			if (!adExists)
				throw new InvalidOperationException("Ad does not exist.");

			var favorite = await context.Favorites
				.FirstOrDefaultAsync(f => f.AdId == adId && f.UserId == userId);

			if (favorite == null)
			{
				context.Favorites.Add(new Favorite
				{
					AdId = adId,
					UserId = userId
				});

				await context.SaveChangesAsync();
				return true;
			}

			context.Favorites.Remove(favorite);
			await context.SaveChangesAsync();
			return false;
		}

		public async Task<bool> IsFavoriteAsync(int adId, string userId)
		{
			return await context.Favorites.AnyAsync(f =>
				f.AdId == adId && f.UserId == userId);
		}

		public async Task<IEnumerable<AdListItemViewModel>> GetFavoritesAsync(string userId)
		{
			return await context.Ads
				.AsNoTracking()
				.Where(a => context.Favorites.Any(f => f.AdId == a.Id
				 && f.UserId == userId))
				.Select(a => new AdListItemViewModel
				{
					Id = a.Id,
					Title = a.Title,
					Price = a.Price,
					Currency = a.Currency,
					CreatedOn = a.CreatedOn,
					MainImageUrl = a.Images
						.OrderBy(i => i.Id)
						.Select(i => i.ImageUrl)
						.FirstOrDefault()
				})
				.ToListAsync();
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\ImageService.cs ================

using MarketZone.Services.Interfaces;

namespace MarketZone.Services.Implementations
{
	public class ImageService : IImageService
	{
		private readonly IWebHostEnvironment env;

		private const long MaxFileSizeBytes = 5 * 1024 * 1024; // 5 MB

		private static readonly string[] AllowedExtensions =
			{ ".jpg", ".jpeg", ".png", ".webp" };

		private static readonly string[] AllowedMimeTypes =
		{
			"image/jpeg",
			"image/png",
			"image/webp"
		};
		public ImageService(IWebHostEnvironment env)
		{
			this.env = env;
		}

		public Task<string> UploadChatImageAsync(IFormFile image)
		{
			return UploadImageAsync(image, "chat");
		}

		public Task<string> UploadAdImageAsync(IFormFile image)
		{
			return UploadImageAsync(image, "ads");
		}
		public Task DeleteImageAsync(string imageUrl)
		{
			if (string.IsNullOrWhiteSpace(imageUrl))
				return Task.CompletedTask;

			var physicalPath = Path.Combine(
				env.WebRootPath,
				imageUrl.TrimStart('/')
			);

			if (File.Exists(physicalPath))
			{
				File.Delete(physicalPath);
			}

			return Task.CompletedTask;
		}

		private async Task<string> UploadImageAsync(
			IFormFile image,
			string subFolder)
		{
			if (image == null || image.Length == 0)
				throw new ArgumentException("Image is empty.");

			if (image.Length > MaxFileSizeBytes)
				throw new ArgumentException("Image size exceeds limit.");

			var extension = Path.GetExtension(image.FileName).ToLowerInvariant();

			if (!AllowedExtensions.Contains(extension))
				throw new ArgumentException("Invalid image extension.");

			if (!AllowedMimeTypes.Contains(image.ContentType))
				throw new ArgumentException("Invalid image MIME type.");

			var fileName = $"{Guid.NewGuid()}{extension}";
			var uploadPath = Path.Combine(env.WebRootPath, "uploads", subFolder);

			Directory.CreateDirectory(uploadPath);

			var fullPath = Path.Combine(uploadPath, fileName);

			using var stream = new FileStream(fullPath, FileMode.Create);
			await image.CopyToAsync(stream);

			return $"/uploads/{subFolder}/{fileName}";
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\MessageService.cs ================

using MarketZone.Data;
using MarketZone.Data.Models;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Message;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class MessageService : IMessageService
	{
		private readonly ApplicationDbContext context;

		public MessageService(ApplicationDbContext context)
		{
			this.context = context;
		}

		public async Task<ChatViewModel?> GetChatAsync(int adId, string currentUserId, string otherUserId)
		{
			if (string.IsNullOrWhiteSpace(otherUserId))
				return null;

			// Load ad + seller
			var ad = await context.Ads
				.Include(a => a.User)
				.Include(a => a.Images)
				.AsNoTracking()
				.FirstOrDefaultAsync(a => a.Id == adId);

			if (ad == null)
				return null;

			// Must be either: (current is seller) or (current is buyer)
			// And otherUser must be the other side.
			bool currentIsSeller = ad.UserId == currentUserId;
			bool otherIsSeller = ad.UserId == otherUserId;

			// Valid pairs:
			// - currentIsSeller && !otherIsSeller
			// - !currentIsSeller && otherIsSeller
			if (currentIsSeller == otherIsSeller)
				return null;

			// Pull only messages for this exact conversation (two users + ad)
			var messages = await context.Messages
				.Where(m => m.AdId == adId &&
					((m.SenderId == currentUserId && m.ReceiverId == otherUserId) ||
					 (m.SenderId == otherUserId && m.ReceiverId == currentUserId)))
				.Include(m => m.Sender)
				.Include(m => m.Images)
				.OrderBy(m => m.SentOn)
				.Select(m => new ChatMessageViewModel
				{
					SenderId = m.SenderId,
					SenderName = m.Sender.UserName!,
					SenderProfileImage = m.Sender.ProfilePictureUrl, // ✅ use real image
					Content = m.Content,
					ImageUrls = m.Images.Select(i => i.ImageUrl).ToList(),
					SentOn = m.SentOn
				})
				.AsNoTracking()
				.ToListAsync();

			// Determine other user's name
			string otherUserName;
			if (otherIsSeller)
			{
				otherUserName = ad.User.UserName!;
			}
			else
			{
				// other is buyer
				otherUserName = await context.Users
					.AsNoTracking()
					.Where(u => u.Id == otherUserId)
					.Select(u => u.UserName!)
					.FirstOrDefaultAsync() ?? "Unknown user";
			}

			var buyerId = currentIsSeller ? otherUserId : currentUserId;

			return new ChatViewModel
			{
				AdId = adId,
				ChatId = $"ad_{adId}_u_{buyerId}",
				OtherUserId = otherUserId,
				OtherUserName = otherUserName,
				CurrentUserId = currentUserId,
				Messages = messages,
				AdTitle = ad.Title,
				AdImageUrl = ad.Images
					.OrderBy(i => i.Id)
					.Select(i => i.ImageUrl)
					.FirstOrDefault() ?? "/images/no-image.png"
			};

		}

		public async Task SaveMessageAsync(int adId, string senderId, string receiverId, string? content, List<string> imageUrls)
		{
			var ad = await context.Ads.AsNoTracking().FirstOrDefaultAsync(a => a.Id == adId);
			if (ad == null)
				throw new InvalidOperationException("Ad not found.");

			if (string.IsNullOrWhiteSpace(senderId) || string.IsNullOrWhiteSpace(receiverId))
				throw new InvalidOperationException("Invalid sender/receiver.");

			// Validate that this receiver makes sense for this ad
			// One must be seller (ad owner), the other must be non-seller.
			bool senderIsSeller = ad.UserId == senderId;
			bool receiverIsSeller = ad.UserId == receiverId;
			if (senderIsSeller == receiverIsSeller)
				throw new InvalidOperationException("Invalid conversation participants.");

			if (string.IsNullOrWhiteSpace(content) && !imageUrls.Any())
				throw new InvalidOperationException("Message must contain text or images.");

			var message = new Message
			{
				AdId = adId,	
				SenderId = senderId,
				ReceiverId = receiverId,
				Content = content ?? string.Empty,
				SentOn = DateTime.UtcNow
			};

			context.Messages.Add(message);
			await context.SaveChangesAsync();

			if (imageUrls.Any())
			{
				foreach (var url in imageUrls)
				{
					context.MessageImages.Add(new MessageImage
					{
						MessageId = message.Id,
						ImageUrl = url
					});
				}

				await context.SaveChangesAsync();
			}
		}

		public async Task<InboxViewModel> GetInboxAsync(string userId, string mode)
		{
			mode = (mode ?? "buying").ToLowerInvariant();

			// 1) Base query WITHOUT Include (important!)
			IQueryable<Message> baseQuery = context.Messages
				.AsNoTracking()
				.Where(m => m.SenderId == userId || m.ReceiverId == userId);

			// selling = chats for ads I own, buying = chats for ads I don't own
			if (mode == "selling")
				baseQuery = baseQuery.Where(m => m.Ad.UserId == userId);
			else
				baseQuery = baseQuery.Where(m => m.Ad.UserId != userId);

			// 2) Get only the latest message Id per Ad (still NO Include)
			// ✅ Group by (AdId + OtherUserId) so seller gets one thread per buyer per ad
			var latestMessageIds = await baseQuery
				.Select(m => new
				{
					m.Id,
					m.AdId,
					m.SentOn,
					OtherUserId = (m.SenderId == userId) ? m.ReceiverId : m.SenderId
				})
				.GroupBy(x => new { x.AdId, x.OtherUserId })
				.Select(g => g
					.OrderByDescending(x => x.SentOn)
					.Select(x => x.Id)
					.First())
				.ToListAsync();

			// 3) Now load the message rows we need WITH Include
			var chats = await context.Messages
				.AsNoTracking()
				.Where(m => latestMessageIds.Contains(m.Id))
				.Include(m => m.Ad)
				.Include(m => m.Sender)
				.Include(m => m.Receiver)
				.Select(m => new InboxChatItemViewModel
				{
					AdId = m.AdId,
					AdTitle = m.Ad.Title,

					// if I'm sender -> other is receiver, else other is sender
					OtherUserId = m.SenderId == userId ? m.ReceiverId : m.SenderId,
					OtherUserName = m.SenderId == userId
						? m.Receiver.UserName!
						: m.Sender.UserName!,

					LastMessage = m.Content,
					LastMessageTime = m.SentOn
				})
				.OrderByDescending(c => c.LastMessageTime)
				.ToListAsync();

			return new InboxViewModel
			{
				Mode = mode,
				Chats = chats
			};
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\ReviewService.cs ================

using MarketZone.Data;
using MarketZone.Data.Models;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Review;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class ReviewService : IReviewService
	{
		private readonly ApplicationDbContext context;

		public ReviewService(ApplicationDbContext context)
		{
			this.context = context;
		}

		public async Task AddReviewAsync(string reviewerId, ReviewCreateViewModel model)
		{
			if (reviewerId == model.ReviewedUserId)
				throw new InvalidOperationException("You cannot review yourself.");

			bool alreadyReviewed = await context.Reviews.AnyAsync(r =>
				r.ReviewerId == reviewerId &&
				r.ReviewedUserId == model.ReviewedUserId);

			if (alreadyReviewed)
				throw new InvalidOperationException("You have already reviewed this user.");

			var review = new Review
			{
				ReviewerId = reviewerId,
				ReviewedUserId = model.ReviewedUserId,
				Rating = model.Rating, // int (1–5)
				Comment = model.Comment ?? string.Empty,
				CreatedOn = DateTime.UtcNow
			};

			context.Reviews.Add(review);
			await context.SaveChangesAsync();
		}

		public async Task<bool> CanReviewAsync(string reviewerId, string reviewedUserId)
		{
			if (reviewerId == reviewedUserId)
				return false;

			return !await context.Reviews.AnyAsync(r =>
				r.ReviewerId == reviewerId &&
				r.ReviewedUserId == reviewedUserId);
		}

		public async Task<IEnumerable<ReviewViewModel>> GetReviewsForUserAsync(string userId)
		{
			return await context.Reviews
				.AsNoTracking()
				.Where(r => r.ReviewedUserId == userId)
				.OrderByDescending(r => r.CreatedOn)
				.Select(r => new ReviewViewModel
				{
					Id = r.Id,
					ReviewerId = r.ReviewerId,

					Rating = r.Rating,
					Comment = r.Comment,
					CreatedOn = r.CreatedOn,

					ReviewerName = r.Reviewer.UserName!,
					ReviewerProfilePictureUrl = r.Reviewer.ProfilePictureUrl
				})
				.ToListAsync();
		}

		public async Task<double> GetAverageRatingAsync(string userId)
		{
			return await context.Reviews
				.AsNoTracking()
				.Where(r => r.ReviewedUserId == userId)
				.AverageAsync(r => (double?)r.Rating) ?? 0;
		}

		public async Task<int> GetReviewCountAsync(string userId)
		{
			return await context.Reviews.CountAsync(r => r.ReviewedUserId == userId);
		}

		public async Task<ReviewEditViewModel?> GetForEditAsync(int reviewId)
		{
			return await context.Reviews
				.AsNoTracking()
				.Where(r => r.Id == reviewId)
				.Select(r => new ReviewEditViewModel
				{
					Id = r.Id,
					Rating = r.Rating,
					Comment = r.Comment,
					ReviewedUserId = r.ReviewedUserId
				})
				.FirstOrDefaultAsync();
		}

		public async Task<bool> UpdateAsync(ReviewEditViewModel model, string reviewerId)
		{
			var review = await context.Reviews.FindAsync(model.Id);

			if (review == null)
				return false;

			if (review.ReviewerId != reviewerId)
				return false;

			review.Rating = model.Rating;
			review.Comment = model.Comment ?? string.Empty;

			await context.SaveChangesAsync();
			return true;
		}

		public async Task<bool> DeleteAsync(int reviewId, string reviewerId)
		{
			var review = await context.Reviews.FindAsync(reviewId);

			if (review == null)
				return false;

			if (review.ReviewerId != reviewerId)
				return false;

			context.Reviews.Remove(review);
			await context.SaveChangesAsync();
			return true;
		}

		public async Task<bool> CanUserEditAsync(int reviewId, string reviewerId)
		{
			return await context.Reviews.AnyAsync(r =>
				r.Id == reviewId &&
				r.ReviewerId == reviewerId);
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Implementations\UserService.cs ================

using MarketZone.Data;
using MarketZone.Services.Interfaces;
using MarketZone.ViewModels.Ad;
using MarketZone.ViewModels.User;
using Microsoft.EntityFrameworkCore;

namespace MarketZone.Services.Implementations
{
	public class UserService : IUserService
	{
		private readonly ApplicationDbContext context;
		private readonly IReviewService reviewService;
		private readonly ICategoryHierarchyService categoryHierarchyService;

		public UserService(
			ApplicationDbContext context,
			IReviewService reviewService,
			ICategoryHierarchyService categoryHierarchyService)
		{
			this.context = context;
			this.reviewService = reviewService;
			this.categoryHierarchyService = categoryHierarchyService;
		}

		public async Task<UserProfileViewModel> GetProfileAsync(string userId,
		string? search, string? address,int? categoryId, decimal? minPrice,
		decimal? maxPrice, string? tags,string? sort, int page, string? viewerId)
		{
			const int PageSize = 21;

			var user = await context.Users
				.AsNoTracking()
				.FirstOrDefaultAsync(u => u.Id == userId);

			if (user == null)
				throw new ArgumentException("User not found");

			var adsQuery = context.Ads
				.AsNoTracking()
				.Where(a => a.UserId == userId)
				.AsQueryable();

			// Search (title + description)
			if (!string.IsNullOrWhiteSpace(search))
				adsQuery = adsQuery.Where(a =>
					a.Title.Contains(search) ||
					a.Description.Contains(search));

			// Address scaling (token-based matching)
			if (!string.IsNullOrWhiteSpace(address))
			{
				var tokens = address
					.ToLower()
					.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries)
					.Distinct()
					.ToList();

				foreach (var t in tokens)
				{
					var token = t;
					adsQuery = adsQuery.Where(a =>
						a.Address.ToLower().Contains(token));
				}
			}

			// Category (selected + descendants)
			if (categoryId.HasValue)
			{
				var allowedCategoryIds = await categoryHierarchyService
				.GetDescendantCategoryIdsAsync(categoryId.Value);

				adsQuery = adsQuery.Where(a => allowedCategoryIds.Contains(a.CategoryId));
			}

			// Price
			if (minPrice.HasValue)
				adsQuery = adsQuery.Where(a => a.Price >= minPrice.Value);

			if (maxPrice.HasValue)
				adsQuery = adsQuery.Where(a => a.Price <= maxPrice.Value);

			// Tags (max 10)
			if (!string.IsNullOrWhiteSpace(tags))
			{
				var tagList = tags
					.Split(',', StringSplitOptions.RemoveEmptyEntries)
					.Select(t => t.Trim().ToLower())
					.Where(t => !string.IsNullOrWhiteSpace(t))
					.Distinct()
					.Take(10)
					.ToList();

				if (tagList.Count > 0)
				{
					adsQuery = adsQuery.Where(a =>
						a.AdTags.Any(at =>
							tagList.Contains(at.Tag.Name.ToLower())));
				}
			}

			// Sorting
			adsQuery = sort switch
			{
				"price_asc" => adsQuery.OrderBy(a => a.Price),
				"price_desc" => adsQuery.OrderByDescending(a => a.Price),
				"oldest" => adsQuery.OrderBy(a => a.CreatedOn),
				_ => adsQuery.OrderByDescending(a => a.CreatedOn)
			};

			var totalAds = await adsQuery.CountAsync();

			var ads = await adsQuery
				.Skip((page - 1) * PageSize)
				.Take(PageSize)
				.Select(a => new AdListItemViewModel
				{
					Id = a.Id,
					Title = a.Title,
					Price = a.Price,
					Currency = a.Currency,
					CreatedOn = a.CreatedOn,
					MainImageUrl = a.Images
						.OrderBy(i => i.Id)
						.Select(i => i.ImageUrl)
						.FirstOrDefault()
				})
				.ToListAsync();

			var reviews = await reviewService.GetReviewsForUserAsync(userId);

			var reviewStats = await context.Reviews
				.AsNoTracking()
				.Where(r => r.ReviewedUserId == userId)
				.GroupBy(r => r.ReviewedUserId)
				.Select(g => new
				{
					AverageRating = g.Average(r => (double?)r.Rating) ?? 0,
					ReviewCount = g.Count()
				})
				.FirstOrDefaultAsync();

			bool canReview = false;

			if (!string.IsNullOrWhiteSpace(viewerId))
				canReview = await reviewService.CanReviewAsync(viewerId, userId);

			string? categoryName = null;
			if (categoryId.HasValue)
			{
				categoryName = await context.Categories
					.AsNoTracking()
					.Where(c => c.Id == categoryId.Value)
					.Select(c => c.Name)
					.FirstOrDefaultAsync();
			}

			return new UserProfileViewModel
			{
				UserId = user.Id,
				UserName = user.UserName!,
				Email = user.Email!,
				ProfilePictureUrl = user.ProfilePictureUrl,
				CreatedOn = user.CreatedOn,
				LastOnlineOn = user.LastOnlineOn,

				SearchTerm = search,
				Address = address,
				CategoryId = categoryId,
				CategoryName = categoryName,
				MinPrice = minPrice,
				MaxPrice = maxPrice,
				Tags = tags,
				Sort = sort,

				CurrentPage = page,
				TotalPages = (int)Math.Ceiling(totalAds / (double)PageSize),

				Ads = ads,
				Reviews = reviews,
				AverageRating = reviewStats?.AverageRating ?? 0,
				ReviewCount = reviewStats?.ReviewCount ?? 0,
				CanReview = canReview
			};
		}
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IAdService.cs ================

using MarketZone.ViewModels.Ad;

namespace MarketZone.Services.Interfaces
{
	public interface IAdService
	{
		Task<int> CreateAsync(AdCreateModel model, string userId);
		Task<AdDetailsModel?> GetDetailsAsync(int id, string? userId);
		Task<IEnumerable<AdListItemViewModel>> GetMyAdsAsync(string userId);
		Task<AdCreateModel?> GetEditModelAsync(int adId, string userId);
		Task<bool> UpdateAsync(AdCreateModel model, string userId);	
        Task<bool> DeleteAsync(int adId, string userId);
		Task<AdSearchViewModel> SearchAsync(string? search,string? address,
	    int? categoryId,decimal? minPrice,decimal? maxPrice,string? tags,
	    string? sort,int page,string? userId);

	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\ICategoryHierarchyService.cs ================

namespace MarketZone.Services.Interfaces
{
	public interface ICategoryHierarchyService
	{
		Task<List<int>> GetDescendantCategoryIdsAsync(int rootId);
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\ICategoryService.cs ================

using MarketZone.ViewModels.Category;

namespace MarketZone.Services.Interfaces
{
	public interface ICategoryService
	{
		Task<IEnumerable<CategorySelectModel>> GetAllAsync();
		Task<IEnumerable<CategoryChildDto>> GetChildrenAsync(int? parentId);

	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IFavoriteService.cs ================

using MarketZone.ViewModels.Ad;

namespace MarketZone.Services.Interfaces
{
	public interface IFavoriteService
	{
		Task<bool> ToggleAsync(int adId, string userId);
		Task<bool> IsFavoriteAsync(int adId, string userId);
		Task<IEnumerable<AdListItemViewModel>> GetFavoritesAsync(string userId);
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IImageService.cs ================


namespace MarketZone.Services.Interfaces
{
	public interface IImageService
	{
		Task<string> UploadChatImageAsync(IFormFile image);
		Task<string> UploadAdImageAsync(IFormFile image);
		Task DeleteImageAsync(string imageUrl);
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IMessageService.cs ================

using MarketZone.ViewModels.Message;

namespace MarketZone.Services.Interfaces
{
	public interface IMessageService
	{
		Task<ChatViewModel?> GetChatAsync(int adId, string currentUserId, string otherUserId);

		Task SaveMessageAsync(
			int adId,
			string senderId,
			string receiverId,
			string? content,
			List<string> imageUrls);

		Task<InboxViewModel> GetInboxAsync(string userId, string mode);
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IReviewService.cs ================

using MarketZone.ViewModels.Review;

namespace MarketZone.Services.Interfaces
{
	public interface IReviewService
	{
		Task AddReviewAsync(string reviewerId, ReviewCreateViewModel model);

		Task<bool> CanReviewAsync(string reviewerId, string reviewedUserId);

		Task<IEnumerable<ReviewViewModel>> GetReviewsForUserAsync(string userId);

		Task<double> GetAverageRatingAsync(string userId);

		Task<int> GetReviewCountAsync(string userId);

		Task<ReviewEditViewModel?> GetForEditAsync(int reviewId);

		Task<bool> UpdateAsync(ReviewEditViewModel model, string reviewerId);

		Task<bool> DeleteAsync(int reviewId, string reviewerId);

		Task<bool> CanUserEditAsync(int reviewId, string reviewerId);
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Services\Interfaces\IUserService.cs ================

using MarketZone.ViewModels.User;

namespace MarketZone.Services.Interfaces
{
	public interface IUserService
	{
		Task<UserProfileViewModel> GetProfileAsync(string userId, string? search,
		string? address,int? categoryId, decimal? minPrice, decimal? maxPrice,
		string? tags,string? sort, int page, string? viewerId);

	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Ad\AdCreateModel.cs ================

using MarketZone.Data.Enums;
using MarketZone.Models.Enums;
using MarketZone.ViewModels.Category;
using System.ComponentModel.DataAnnotations;

namespace MarketZone.ViewModels.Ad
{
	public class AdCreateModel
	{
		public int Id { get; set; }

		[Required]
		[StringLength(100)]
		public string Title { get; set; } = null!;

		[Required]
		[MinLength(40)]
		[MaxLength(4000)]
		public string Description { get; set; } = null!;

		[Required]
		[Range(0.01, double.MaxValue, ErrorMessage = "Price must be greater than 0.")]
		public decimal Price { get; set; }

		[Required]
		public Currency Currency { get; set; }

		[Required(ErrorMessage = "Please select a category.")]
		[Range(1, int.MaxValue, ErrorMessage = "Please select a valid category.")]
		public int? CategoryId { get; set; }

		public IEnumerable<CategorySelectModel> Categories { get; set; }
			= new List<CategorySelectModel>();
		public List<string> ExistingImageUrls { get; set; } = new();

		public List<IFormFile> Images { get; set; } = new();

		[Required(ErrorMessage = "Please select an address.")]
		[StringLength(200)]
		public string Address { get; set; } = null!;
		public double? Latitude { get; set; }
		public double? Longitude { get; set; }

		[Required]
		public ItemCondition Condition { get; set; }

		[MaxLength(500)]
		public string? Tags { get; set; }
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Ad\AdDetailsModel.cs ================

using MarketZone.Data.Enums;
using MarketZone.Models.Enums;

namespace MarketZone.ViewModels.Ad
{
	public class AdDetailsModel
	{
		public int Id { get; set; }

		public string Title { get; set; } = null!;
		public string Description { get; set; } = null!;

		public decimal Price { get; set; }
		public Currency Currency { get; set; }

		public ItemCondition Condition { get; set; }

		public bool IsFavorite { get; set; }

		public string CategoryPath { get; set; } = null!;
		public string Address { get; set; } = null!;
		public double? Latitude { get; set; }
		public double? Longitude { get; set; }
		public DateTime CreatedOn { get; set; }

		public string SellerId { get; set; } = null!;
		public string SellerName { get; set; } = null!;

		public List<string> ImageUrls { get; set; } = new();
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Ad\AdListItemViewModel.cs ================

using MarketZone.Data.Enums;

namespace MarketZone.ViewModels.Ad
{
	public class AdListItemViewModel
	{
		public int Id { get; set; }

		public string Title { get; set; } = null!;

		public decimal Price { get; set; }

		public Currency Currency { get; set; }

		public string? MainImageUrl { get; set; }

		public DateTime CreatedOn { get; set; }
		public bool CanEdit { get; set; }
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Ad\AdSearchViewModel.cs ================

namespace MarketZone.ViewModels.Ad
{
	public class AdSearchViewModel : SearchFiltersBaseViewModel
	{

		public IEnumerable<AdListItemViewModel> Ads { get; set; }
			= new List<AdListItemViewModel>();
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Ad\SearchFiltersBaseViewModel.cs ================

namespace MarketZone.ViewModels.Ad
{
	public abstract class SearchFiltersBaseViewModel
	{
		public string? SearchTerm { get; set; }
		public string? Address { get; set; }

		public int? CategoryId { get; set; }
		public string? CategoryName { get; set; }

		public decimal? MinPrice { get; set; }
		public decimal? MaxPrice { get; set; }

		public string? Tags { get; set; }
		public string? Sort { get; set; }

		public int CurrentPage { get; set; } = 1;
		public int TotalPages { get; set; }
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Category\CategoryChildDto.cs ================

namespace MarketZone.ViewModels.Category
{
	public class CategoryChildDto
	{
		public int Id { get; set; }
		public string Name { get; set; } = null!;
		public bool HasChildren { get; set; }
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Category\CategorySelectModel.cs ================

namespace MarketZone.ViewModels.Category
{
	public class CategorySelectModel
	{
		public int Id { get; set; }
		public string Name { get; set; } = null!;
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Message\ChatMessageViewModel.cs ================

namespace MarketZone.ViewModels.Message
{
	public class ChatMessageViewModel
	{
		public string SenderId { get; set; } = null!;
		public string SenderName { get; set; } = null!;
		public string SenderProfileImage { get; set; } = "/images/default-avatar.png";
		public string Content { get; set; } = null!;
		public DateTime SentOn { get; set; }
		public List<string> ImageUrls { get; set; } = new();
	}


}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Message\ChatViewModel.cs ================

namespace MarketZone.ViewModels.Message
{
	public class ChatViewModel
	{
		public int AdId { get; set; }

		// Unique per conversation (Ad + 2 users)
		public string ChatId { get; set; } = null!;

		// The other participant in THIS conversation
		public string OtherUserId { get; set; } = null!;
		public string OtherUserName { get; set; } = null!;

		public string CurrentUserId { get; set; } = null!;

		public List<ChatMessageViewModel> Messages { get; set; } = new();

		// Ad preview (for chat header)
		public string AdTitle { get; set; } = null!;
		public string AdImageUrl { get; set; } = null!;
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Message\InboxChatItemViewModel.cs ================

namespace MarketZone.ViewModels.Message
{
	public class InboxChatItemViewModel
	{
		public int AdId { get; set; }
		public string OtherUserId { get; set; } = null!;
		public string AdTitle { get; set; } = null!;
		public string OtherUserName { get; set; } = null!;
		public string LastMessage { get; set; } = null!;
		public DateTime LastMessageTime { get; set; }
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Message\InboxViewModel.cs ================

namespace MarketZone.ViewModels.Message
{
	public class InboxViewModel
	{
		public string Mode { get; set; } = "buying";
		public List<InboxChatItemViewModel> Chats { get; set; } = new();
	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Review\ReviewCreateViewModel.cs ================

using System.ComponentModel.DataAnnotations;

namespace MarketZone.ViewModels.Review
{
	public class ReviewCreateViewModel: ReviewFormViewModel
	{
		
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Review\ReviewEditViewModel.cs ================

using System.ComponentModel.DataAnnotations;

namespace MarketZone.ViewModels.Review
{
	public class ReviewEditViewModel: ReviewFormViewModel
	{
		public int Id { get; set; }

	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Review\ReviewFormViewModel.cs ================

using System.ComponentModel.DataAnnotations;

namespace MarketZone.ViewModels.Review
{
	public abstract class ReviewFormViewModel
	{
		[Required]
		[Range(1, 5, ErrorMessage = "Rating must be between 1 and 5.")]
		public int Rating { get; set; }
		public string? Comment { get; set; }
		public string ReviewedUserId { get; set; } = null!;
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\Review\ReviewViewModel.cs ================

namespace MarketZone.ViewModels.Review
{
	public class ReviewViewModel
	{
		public int Id { get; set; }
		public string ReviewerId { get; set; } = null!;
		public int Rating { get; set; }
		public string? Comment { get; set; }
		public DateTime CreatedOn { get; set; }

		public string ReviewerName { get; set; } = null!;
		public string ReviewerProfilePictureUrl { get; set; } = "/images/default-avatar.png";
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\User\UserProfileViewModel.cs ================

using MarketZone.ViewModels.Ad;
using MarketZone.ViewModels.Review;

namespace MarketZone.ViewModels.User
{
	public class UserProfileViewModel : SearchFiltersBaseViewModel
	{
		// User info
		public string UserId { get; set; } = null!;
		public string UserName { get; set; } = null!;
		public string Email { get; set; } = null!;
		public string ProfilePictureUrl { get; set; } = "/images/default-avatar.png";

		public DateTime CreatedOn { get; set; }
		public DateTime? LastOnlineOn { get; set; }

		// Ads
		public IEnumerable<AdListItemViewModel> Ads { get; set; }
			= new List<AdListItemViewModel>();

		//Reviews
		public IEnumerable<ReviewViewModel> Reviews { get; set; }
			= new List<ReviewViewModel>();

		public double AverageRating { get; set; }
		public int ReviewCount { get; set; }
		public bool CanReview { get; set; }

		//Last Online Dislay
		public string? LastOnlineDisplay =>
	    LastOnlineOn == null
		? "Never"
		: FormatLastOnline(LastOnlineOn.Value);

		private static string FormatLastOnline(DateTime date)
		{
			var now = DateTime.UtcNow;

			if (date.Date == now.Date)
				return date.ToString("HH:mm");

			if (date.Date == now.AddDays(-1).Date)
				return $"Yesterday";

			if (date.Year == now.Year)
				return date.ToString("dd MMM");

			return date.ToString("yyyy MMM dd");
		}

	}

}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\ViewModels\ErrorViewModel.cs ================

namespace MarketZone.ViewModels
{
    public class ErrorViewModel 
    {
        public string? RequestId { get; set; }
        public bool ShowRequestId => !string.IsNullOrEmpty(RequestId);
		public string? Message { get; set; }
	}
}


================ FILE: C:\Users\ASUS\Desktop\SoftUni2\MarketZone\MarketZone\Views\Ad\Create.cshtml ================

@model MarketZone.ViewModels.Ad.AdCreateModel

@{
    ViewData["Title"] = "Create Ad";
}

<h2>Create Ad</h2>

<form id="ad-form" asp-action="Create" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <partial name="_AdFormPartial" model="Model" />
    <button id="submit-btn" type="submit" class="btn btn-primary mt-3">
        Create Ad
    </button>
</form>

