@page
@model MarketZone.Areas.Identity.Pages.Account.VerifyEmailCodeModel

@{
    ViewData["Title"] = "Verify Email";
}

<div class="d-flex justify-content-center align-items-center" style="min-height:70vh;">
    <div class="card p-4 shadow-sm"
         style="max-width:420px;width:100%;position:relative;">

        <h3 class="text-center mb-3">Verify your email</h3>

        <p class="text-center text-muted">
            We sent a 6-digit verification code to
            <strong>@Model.MaskedEmail</strong>
        </p>

        <form method="post" id="verifyForm">
            @Html.AntiForgeryToken()

            <input type="hidden" asp-for="Input.Email" />
            <input type="hidden" asp-for="Input.Code" id="otpCode" />

            <div class="d-flex justify-content-between mb-3">
                @for (int i = 0; i < 6; i++)
                {
                    <input type="text"
                           class="form-control text-center otp-input"
                           maxlength="1"
                           inputmode="numeric"
                           autocomplete="one-time-code"
                           style="width:48px;font-size:1.25rem;" />
                }
            </div>

            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="text-danger text-center mb-2">
                    @Model.ErrorMessage
                </div>
            }

            <button type="submit" class="btn btn-primary w-100">
                Verify code
            </button>
        </form>

        <!-- RESEND -->
        <div class="mt-3 text-center"
             style="position:relative; z-index:9999; pointer-events:auto;">

            <span id="resendBtn"
                  style="
                      display:inline-block;
                      padding:10px 16px;
                      border:2px solid #0d6efd;
                      border-radius:8px;
                      color:#0d6efd;
                      cursor:pointer;
                      user-select:none;
                  ">
                Resend code
            </span>

            <div id="cooldownText" class="text-muted mt-2"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const inputs = document.querySelectorAll('.otp-input');
            const hiddenCode = document.getElementById('otpCode');
            const resendBtn = document.getElementById('resendBtn');
            const cooldownText = document.getElementById('cooldownText');
            const email = document.querySelector('input[name="Input.Email"]').value;

            /* OTP INPUT */

            function syncCode() {
                hiddenCode.value = [...inputs].map(i => i.value).join('');
            }

            inputs.forEach((input, index) => {

                input.addEventListener('input', () => {
                    const value = input.value.replace(/[^0-9]/g, '');
                    input.value = value;

                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }

                    syncCode();
                });

                input.addEventListener('keydown', e => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', e => {
                    const pasted = e.clipboardData
                        .getData('text')
                        .replace(/\D/g, '')
                        .slice(0, 6);

                    if (!pasted) return;

                    inputs.forEach((box, i) => {
                        box.value = pasted[i] || '';
                    });

                    syncCode();
                    inputs[Math.min(pasted.length, 5)].focus();
                    e.preventDefault();
                });
            });

            /* RESEND */

            let cooldown = 0;
            let timer = null;

            resendBtn.onclick = async () => {
                if (cooldown > 0) return;

                startCooldown(30); // show immediately

                const response = await fetch('?handler=Resend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken':
                            document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ email })
                });

                if (!response.ok) {
                    stopCooldown(); // rollback if failed
                }
            };

            function startCooldown(seconds) {
                cooldown = seconds;

                resendBtn.style.pointerEvents = 'none';
                resendBtn.style.color = '#6c757d';
                resendBtn.style.borderColor = '#adb5bd';
                resendBtn.style.cursor = 'default';

                cooldownText.innerText = `Resend available in ${cooldown}s`;

                timer = setInterval(() => {
                    cooldown--;
                    cooldownText.innerText = `Resend available in ${cooldown}s`;

                    if (cooldown <= 0) {
                        stopCooldown();
                    }
                }, 1000);
            }

            function stopCooldown() {
                clearInterval(timer);
                cooldown = 0;

                resendBtn.style.pointerEvents = 'auto';
                resendBtn.style.color = '#0d6efd';
                resendBtn.style.borderColor = '#0d6efd';
                resendBtn.style.cursor = 'pointer';

                cooldownText.innerText = '';
            }
        });
    </script>
}
